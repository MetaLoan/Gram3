<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¡Œæƒ…åˆ†æå›¾ç‰‡è‡ªåŠ¨æ’ç‰ˆå¯¼å‡ºå·¥å…·</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
    min-height: 100vh;
  }
  
  .container {
    max-width: 1400px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  
  .panel {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  }
  
  h1 {
    color: #333;
    margin-bottom: 25px;
    font-size: 24px;
    border-bottom: 3px solid #667eea;
    padding-bottom: 10px;
  }
  
  h2 {
    color: #555;
    margin: 20px 0 15px 0;
    font-size: 18px;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  label {
    display: block;
    margin-bottom: 8px;
    color: #555;
    font-weight: 600;
    font-size: 14px;
  }
  
  input[type="file"] {
    display: none;
  }
  
  .file-upload-btn {
    display: inline-block;
    padding: 10px 20px;
    background: #667eea;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 14px;
  }
  
  .file-upload-btn:hover {
    background: #5568d3;
    transform: translateY(-2px);
  }
  
  .file-name {
    display: inline-block;
    margin-left: 10px;
    color: #666;
    font-size: 13px;
  }
  
  textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 14px;
    font-family: 'Courier New', monospace;
    resize: vertical;
    transition: border-color 0.3s;
  }
  
  #rawContent {
    min-height: 300px;
  }
  
  textarea:focus {
    outline: none;
    border-color: #667eea;
  }
  
  input[type="number"],
  input[type="text"] {
    width: 100%;
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
  }
  
  input[type="number"]:focus,
  input[type="text"]:focus {
    outline: none;
    border-color: #667eea;
  }
  
  .color-input-group {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }
  
  .color-picker {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  input[type="color"] {
    width: 50px;
    height: 40px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  
  .btn-primary {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 10px;
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
  }
  
  .btn-primary:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
  }
  
  .btn-secondary {
    width: 100%;
    padding: 12px;
    background: #10b981;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 10px;
  }
  
  .btn-secondary:hover {
    background: #059669;
    transform: translateY(-2px);
  }
  
  #preview {
    background: #f5f5f5;
    border-radius: 8px;
    overflow: auto;
    min-height: 400px;
    max-height: 80vh;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 20px;
  }
  
  .preview-canvas {
    max-width: 100%;
    height: auto;
    display: block;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
  }
  
  .preview-empty {
    color: #999;
    text-align: center;
    padding: 40px;
  }
  
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }
  
  .tips {
    background: #f0f7ff;
    border-left: 4px solid #667eea;
    padding: 12px;
    margin-top: 15px;
    font-size: 13px;
    color: #555;
    border-radius: 4px;
  }
  
  /* å†å²å›¾ç‰‡æ ·å¼ */
  .history-container {
    margin-top: 15px;
    padding: 15px;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }
  
  .history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .history-title {
    font-size: 13px;
    color: #666;
    font-weight: 600;
  }
  
  .btn-clear-history {
    padding: 4px 12px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .btn-clear-history:hover {
    background: #dc2626;
  }
  
  .history-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }
  
  .history-item {
    position: relative;
    aspect-ratio: 1;
    border-radius: 6px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s;
  }
  
  .history-item:hover {
    border-color: #667eea;
    transform: scale(1.05);
  }
  
  .history-item.selected {
    border-color: #10b981;
    box-shadow: 0 0 0 2px #10b981;
  }
  
  .history-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .history-empty {
    grid-column: 1 / -1;
    text-align: center;
    padding: 20px;
    color: #999;
    font-size: 13px;
  }
  
  /* æŠ˜å æ ·å¼ */
  .collapsible-section {
    margin-top: 20px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
  }
  
  .collapsible-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #f9fafb;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s;
  }
  
  .collapsible-header:hover {
    background: #f3f4f6;
  }
  
  .collapsible-title {
    font-size: 16px;
    font-weight: 600;
    color: #555;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .collapsible-icon {
    transition: transform 0.3s;
    font-size: 12px;
  }
  
  .collapsible-icon.expanded {
    transform: rotate(180deg);
  }
  
  .collapsible-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
  }
  
  .collapsible-content.expanded {
    max-height: 2000px;
    transition: max-height 0.5s ease-in;
  }
  
  .collapsible-inner {
    padding: 20px;
  }
  
  @media (max-width: 1200px) {
    .container {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>
<div class="container">
  <!-- å·¦ä¾§é…ç½®é¢æ¿ -->
  <div class="panel">
    <h1>ğŸ“Š é…ç½®é¢æ¿</h1>
    
    <h2>1. ä¸Šä¼ å›¾ç‰‡</h2>
    <div class="form-group">
      <label>å¤´å›¾ (Header Image)</label>
      <label class="file-upload-btn" for="headerImage">é€‰æ‹©æ–‡ä»¶</label>
      <input type="file" id="headerImage" accept="image/*">
      <span class="file-name" id="headerImageName">æœªé€‰æ‹©æ–‡ä»¶</span>
      
      <!-- å¤´å›¾å†å²è®°å½• -->
      <div class="history-container" id="headerHistoryContainer" style="display: none;">
        <div class="history-header">
          <span class="history-title">ğŸ“š å†å²å¤´å›¾</span>
          <button class="btn-clear-history" onclick="clearHistory('header')">æ¸…é™¤å†å²</button>
        </div>
        <div class="history-grid" id="headerHistory">
          <div class="history-empty">æš‚æ— å†å²è®°å½•</div>
        </div>
      </div>
    </div>
    
    <div class="form-group">
      <label>åˆ†æå›¾ (Analysis Chart)</label>
      <label class="file-upload-btn" for="chartImage">é€‰æ‹©æ–‡ä»¶</label>
      <input type="file" id="chartImage" accept="image/*">
      <span class="file-name" id="chartImageName">æœªé€‰æ‹©æ–‡ä»¶</span>
      
      <!-- åˆ†æå›¾å†å²è®°å½• -->
      <div class="history-container" id="chartHistoryContainer" style="display: none;">
        <div class="history-header">
          <span class="history-title">ğŸ“š å†å²åˆ†æå›¾</span>
          <button class="btn-clear-history" onclick="clearHistory('chart')">æ¸…é™¤å†å²</button>
        </div>
        <div class="history-grid" id="chartHistory">
          <div class="history-empty">æš‚æ— å†å²è®°å½•</div>
        </div>
      </div>
    </div>
    
    <h2>2. ç²˜è´´å®Œæ•´å†…å®¹</h2>
    <div class="form-group">
      <label>ç›´æ¥ç²˜è´´å®Œæ•´æ–‡æœ¬ï¼ˆåŒ…å« [title]ã€[description]ã€[analysis]ã€[note] æ ‡ç­¾ï¼‰</label>
      <textarea id="rawContent" placeholder="ç²˜è´´æ ¼å¼å¦‚ä¸‹ï¼š&#10;[title]10-29å¤§é¥¼è¡Œæƒ…åˆ†æ15å›¾&#10;&#10;[description]å¤§é¥¼éœ‡è¡ä¸Šæ‰¬åå†²é«˜å›è½...&#10;&#10;[analysis]æ“ä½œå»ºè®®ï¼š...&#10;&#10;[note]æŠ•æœºæœ‰é£é™©..."></textarea>
    </div>
    
    <!-- æŠ˜å çš„æ ·å¼è®¾ç½® -->
    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapsible()">
        <span class="collapsible-title">
          ğŸ¨ æ ·å¼è®¾ç½®
        </span>
        <span class="collapsible-icon">â–¼</span>
      </div>
      <div class="collapsible-content" id="styleSettings">
        <div class="collapsible-inner">
          <div class="form-group">
            <label>ç”»å¸ƒå®½åº¦ (px)</label>
            <input type="number" id="canvasWidth" value="1200" min="400" max="2000">
          </div>
          
          <div class="form-group color-input-group">
            <div>
              <label>æ ‡é¢˜å­—å·</label>
              <input type="number" id="titleFontSize" value="50" min="12" max="72">
            </div>
            <div>
              <label>æ ‡é¢˜é¢œè‰²</label>
              <div class="color-picker">
                <input type="color" id="titleColor" value="#FFD700">
                <input type="text" id="titleColorText" value="#FFD700" maxlength="7">
              </div>
            </div>
          </div>
          
          <div class="form-group color-input-group">
            <div>
              <label>æè¿°å­—å·</label>
              <input type="number" id="descriptionFontSize" value="35" min="12" max="48">
            </div>
            <div>
              <label>æè¿°é¢œè‰²</label>
              <div class="color-picker">
                <input type="color" id="descriptionColor" value="#ffffff">
                <input type="text" id="descriptionColorText" value="#ffffff" maxlength="7">
              </div>
            </div>
          </div>
          
          <div class="form-group color-input-group">
            <div>
              <label>åˆ†æå­—å·</label>
              <input type="number" id="analysisFontSize" value="35" min="12" max="48">
            </div>
            <div>
              <label>åˆ†æé¢œè‰²</label>
              <div class="color-picker">
                <input type="color" id="analysisColor" value="#FFD700">
                <input type="text" id="analysisColorText" value="#FFD700" maxlength="7">
              </div>
            </div>
          </div>
          
          <div class="form-group color-input-group">
            <div>
              <label>æ³¨æ„äº‹é¡¹å­—å·</label>
              <input type="number" id="noteFontSize" value="25" min="10" max="36">
            </div>
            <div>
              <label>æ³¨æ„äº‹é¡¹é¢œè‰²</label>
              <div class="color-picker">
                <input type="color" id="noteColor" value="#FFFFFF">
                <input type="text" id="noteColorText" value="#FFFFFF" maxlength="7">
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label>èƒŒæ™¯é¢œè‰²</label>
            <div class="color-picker">
              <input type="color" id="bgColor" value="#000000">
              <input type="text" id="bgColorText" value="#000000" maxlength="7">
            </div>
          </div>
          
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="isArabic">
              <label for="isArabic" style="margin: 0;">é˜¿æ‹‰ä¼¯æ–‡æ¨¡å¼ (å³å¯¹é½)</label>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tips">
      ğŸ’¡ æç¤º: ç›´æ¥ç²˜è´´å®Œæ•´å†…å®¹ï¼Œç‚¹å‡»"ç”Ÿæˆé¢„è§ˆ"è‡ªåŠ¨è§£æå¹¶æ˜¾ç¤ºã€‚é˜¿æ‹‰ä¼¯æ–‡ä¼šè‡ªåŠ¨å³å¯¹é½ï¼Œå…¶ä»–è¯­è¨€é»˜è®¤å·¦å¯¹é½ã€‚è‹±æ–‡å•è¯ä¸ä¼šä»ä¸­é—´æ–­å¼€ã€‚
    </div>
    
    <button class="btn-primary" onclick="generatePreview()">ğŸ¨ ç”Ÿæˆé¢„è§ˆ</button>
    <button class="btn-primary" onclick="exportImage()">ğŸ’¾ å¯¼å‡ºå›¾ç‰‡</button>
  </div>
  
  <!-- å³ä¾§é¢„è§ˆé¢æ¿ -->
  <div class="panel">
    <h1>ğŸ‘ï¸ é¢„è§ˆ</h1>
    <div id="preview">
      <div class="preview-empty">
        <p>ğŸ“‹ è¯·é…ç½®å†…å®¹åç‚¹å‡»"ç”Ÿæˆé¢„è§ˆ"</p>
      </div>
    </div>
  </div>
</div>

<canvas id="canvas" style="display: none;"></canvas>

<script>
  let headerImg = null;
  let chartImg = null;
  let parsedData = {
    title: '',
    description: '',
    analysis: '',
    note: ''
  };
  
  // å†å²è®°å½•ç®¡ç†
  const MAX_HISTORY = 6;
  let headerHistory = [];
  let chartHistory = [];
  
  // ä» localStorage åŠ è½½å†å²è®°å½•
  function loadHistory() {
    const savedHeaderHistory = localStorage.getItem('headerHistory');
    const savedChartHistory = localStorage.getItem('chartHistory');
    
    if (savedHeaderHistory) {
      headerHistory = JSON.parse(savedHeaderHistory);
      renderHistory('header');
    }
    
    if (savedChartHistory) {
      chartHistory = JSON.parse(savedChartHistory);
      renderHistory('chart');
    }
  }
  
  // ä¿å­˜å†å²è®°å½•åˆ° localStorage
  function saveHistory(type) {
    if (type === 'header') {
      localStorage.setItem('headerHistory', JSON.stringify(headerHistory));
    } else {
      localStorage.setItem('chartHistory', JSON.stringify(chartHistory));
    }
  }
  
  // æ·»åŠ åˆ°å†å²è®°å½•
  function addToHistory(type, dataUrl, fileName) {
    const history = type === 'header' ? headerHistory : chartHistory;
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    const existingIndex = history.findIndex(item => item.dataUrl === dataUrl);
    if (existingIndex !== -1) {
      history.splice(existingIndex, 1);
    }
    
    // æ·»åŠ åˆ°å¼€å¤´
    history.unshift({ dataUrl, fileName, timestamp: Date.now() });
    
    // é™åˆ¶æ•°é‡
    if (history.length > MAX_HISTORY) {
      history.pop();
    }
    
    // æ›´æ–°å¼•ç”¨
    if (type === 'header') {
      headerHistory = history;
    } else {
      chartHistory = history;
    }
    
    saveHistory(type);
    renderHistory(type);
  }
  
  // æ¸²æŸ“å†å²è®°å½•
  function renderHistory(type) {
    const history = type === 'header' ? headerHistory : chartHistory;
    const containerId = type === 'header' ? 'headerHistory' : 'chartHistory';
    const containerElement = document.getElementById(containerId);
    const historyContainer = document.getElementById(type === 'header' ? 'headerHistoryContainer' : 'chartHistoryContainer');
    
    if (history.length === 0) {
      containerElement.innerHTML = '<div class="history-empty">æš‚æ— å†å²è®°å½•</div>';
      historyContainer.style.display = 'none';
      return;
    }
    
    historyContainer.style.display = 'block';
    
    containerElement.innerHTML = history.map((item, index) => `
      <div class="history-item" onclick="selectHistoryImage('${type}', ${index})" title="${item.fileName}">
        <img src="${item.dataUrl}" alt="${item.fileName}">
      </div>
    `).join('');
  }
  
  // é€‰æ‹©å†å²å›¾ç‰‡
  function selectHistoryImage(type, index) {
    const history = type === 'header' ? headerHistory : chartHistory;
    const item = history[index];
    
    const img = new Image();
    img.onload = function() {
      if (type === 'header') {
        headerImg = img;
        document.getElementById('headerImageName').textContent = item.fileName;
      } else {
        chartImg = img;
        document.getElementById('chartImageName').textContent = item.fileName;
      }
      
      // æ›´æ–°é€‰ä¸­çŠ¶æ€
      const containerId = type === 'header' ? 'headerHistory' : 'chartHistory';
      const items = document.querySelectorAll(`#${containerId} .history-item`);
      items.forEach((el, i) => {
        if (i === index) {
          el.classList.add('selected');
        } else {
          el.classList.remove('selected');
        }
      });
      
      console.log(`${type}å›¾ä»å†å²è®°å½•åŠ è½½æˆåŠŸ`);
    };
    img.src = item.dataUrl;
  }
  
  // æ¸…é™¤å†å²è®°å½•
  function clearHistory(type) {
    if (!confirm(`ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰${type === 'header' ? 'å¤´å›¾' : 'åˆ†æå›¾'}å†å²è®°å½•å—ï¼Ÿ`)) {
      return;
    }
    
    if (type === 'header') {
      headerHistory = [];
      localStorage.removeItem('headerHistory');
    } else {
      chartHistory = [];
      localStorage.removeItem('chartHistory');
    }
    
    renderHistory(type);
    console.log(`${type}å†å²è®°å½•å·²æ¸…é™¤`);
  }
  
  // æ–‡ä»¶ä¸Šä¼ å¤„ç†
  document.getElementById('headerImage').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      document.getElementById('headerImageName').textContent = file.name;
      const reader = new FileReader();
      reader.onload = function(event) {
        headerImg = new Image();
        headerImg.onload = function() {
          addToHistory('header', event.target.result, file.name);
          console.log('å¤´å›¾åŠ è½½æˆåŠŸ');
        };
        headerImg.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
  
  document.getElementById('chartImage').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      document.getElementById('chartImageName').textContent = file.name;
      const reader = new FileReader();
      reader.onload = function(event) {
        chartImg = new Image();
        chartImg.onload = function() {
          addToHistory('chart', event.target.result, file.name);
          console.log('åˆ†æå›¾åŠ è½½æˆåŠŸ');
        };
        chartImg.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
  
  // æŠ˜å åŠŸèƒ½
  function toggleCollapsible() {
    const content = document.getElementById('styleSettings');
    const icon = document.querySelector('.collapsible-icon');
    
    if (content.classList.contains('expanded')) {
      content.classList.remove('expanded');
      icon.classList.remove('expanded');
    } else {
      content.classList.add('expanded');
      icon.classList.add('expanded');
    }
  }
  
  // é¢œè‰²é€‰æ‹©å™¨åŒæ­¥
  function syncColorPicker(colorId, textId) {
    document.getElementById(colorId).addEventListener('input', function(e) {
      document.getElementById(textId).value = e.target.value;
    });
    document.getElementById(textId).addEventListener('input', function(e) {
      if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
        document.getElementById(colorId).value = e.target.value;
      }
    });
  }
  
  syncColorPicker('titleColor', 'titleColorText');
  syncColorPicker('descriptionColor', 'descriptionColorText');
  syncColorPicker('analysisColor', 'analysisColorText');
  syncColorPicker('noteColor', 'noteColorText');
  syncColorPicker('bgColor', 'bgColorText');
  
  // è§£æå†…å®¹
  function parseContent() {
    const rawContent = document.getElementById('rawContent').value;
    
    if (!rawContent.trim()) {
      return false;
    }
    
    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–å„éƒ¨åˆ†å†…å®¹
    const titleMatch = rawContent.match(/\[title\]([\s\S]*?)(?=\[description\]|\[analysis\]|\[note\]|$)/i);
    const descriptionMatch = rawContent.match(/\[description\]([\s\S]*?)(?=\[title\]|\[analysis\]|\[note\]|$)/i);
    const analysisMatch = rawContent.match(/\[analysis\]([\s\S]*?)(?=\[title\]|\[description\]|\[note\]|$)/i);
    const noteMatch = rawContent.match(/\[note\]([\s\S]*?)(?=\[title\]|\[description\]|\[analysis\]|$)/i);
    
    parsedData.title = titleMatch ? titleMatch[1].trim() : '';
    parsedData.description = descriptionMatch ? descriptionMatch[1].trim() : '';
    parsedData.analysis = analysisMatch ? analysisMatch[1].trim() : '';
    parsedData.note = noteMatch ? noteMatch[1].trim() : '';
    
    // è‡ªåŠ¨æ£€æµ‹æ˜¯å¦ä¸ºé˜¿æ‹‰ä¼¯æ–‡
    const arabicPattern = /[\u0600-\u06FF]/;
    const hasArabic = arabicPattern.test(rawContent);
    
    // å¦‚æœå½“å‰æ˜¯é˜¿æ‹‰ä¼¯æ¨¡å¼ä½†å†…å®¹ä¸åŒ…å«é˜¿æ‹‰ä¼¯æ–‡ï¼Œè‡ªåŠ¨å…³é—­
    if (document.getElementById('isArabic').checked && !hasArabic) {
      document.getElementById('isArabic').checked = false;
    }
    // å¦‚æœå†…å®¹åŒ…å«é˜¿æ‹‰ä¼¯æ–‡ä½†æ¨¡å¼æœªå¼€å¯ï¼Œè‡ªåŠ¨å¼€å¯
    else if (!document.getElementById('isArabic').checked && hasArabic) {
      document.getElementById('isArabic').checked = true;
    }
    
    console.log('å†…å®¹è§£æå®Œæˆ', parsedData);
    return true;
  }
  
  // æ£€æµ‹æ˜¯å¦ä¸ºå•è¯å­—ç¬¦
  function isWordChar(char) {
    return /[a-zA-Z0-9]/.test(char);
  }
  
  // æ™ºèƒ½æ–‡æœ¬æ¢è¡Œå¤„ç†ï¼ˆä¸ä¼šä»å•è¯ä¸­é—´æ–­å¼€ï¼‰
  function wrapText(ctx, text, x, y, maxWidth, lineHeight, align) {
    if (!text) return y;
    
    const lines = text.split('\n');
    let currentY = y;
    
    lines.forEach(line => {
      if (!line.trim()) {
        currentY += lineHeight;
        return;
      }
      
      let words = [];
      let currentWord = '';
      
      // å°†æ–‡æœ¬åˆ†å‰²æˆå•è¯å’Œéå•è¯å­—ç¬¦
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (isWordChar(char)) {
          currentWord += char;
        } else {
          if (currentWord) {
            words.push(currentWord);
            currentWord = '';
          }
          words.push(char);
        }
      }
      if (currentWord) {
        words.push(currentWord);
      }
      
      // æŒ‰å•è¯è¿›è¡Œæ¢è¡Œ
      let currentLine = '';
      
      for (let i = 0; i < words.length; i++) {
        const word = words[i];
        const testLine = currentLine + word;
        const testWidth = ctx.measureText(testLine).width;
        
        if (testWidth > maxWidth && currentLine) {
          // å¦‚æœå½“å‰è¡Œå·²æœ‰å†…å®¹ä¸”åŠ ä¸Šæ–°å•è¯ä¼šè¶…å®½ï¼Œå…ˆè¾“å‡ºå½“å‰è¡Œ
          ctx.fillText(currentLine, x, currentY);
          currentY += lineHeight;
          currentLine = word;
        } else {
          currentLine = testLine;
        }
      }
      
      // è¾“å‡ºæœ€åä¸€è¡Œ
      if (currentLine) {
        ctx.fillText(currentLine, x, currentY);
        currentY += lineHeight;
      }
    });
    
    return currentY;
  }
  
  // é¢„è®¡ç®—æ–‡æœ¬æ¢è¡Œåçš„å®é™…è¡Œæ•°
  function calculateWrappedLines(text, fontSize, maxTextWidth) {
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.font = `${fontSize}px Arial, sans-serif`;
    
    let totalLines = 0;
    const lines = text.split('\n');
    
    lines.forEach(line => {
      if (!line.trim()) {
        totalLines += 1;
        return;
      }
      
      let words = [];
      let currentWord = '';
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (isWordChar(char)) {
          currentWord += char;
        } else {
          if (currentWord) {
            words.push(currentWord);
            currentWord = '';
          }
          words.push(char);
        }
      }
      if (currentWord) {
        words.push(currentWord);
      }
      
      let currentLine = '';
      let lineCount = 0;
      
      for (let i = 0; i < words.length; i++) {
        const word = words[i];
        const testLine = currentLine + word;
        const testWidth = tempCtx.measureText(testLine).width;
        
        if (testWidth > maxTextWidth && currentLine) {
          lineCount++;
          currentLine = word;
        } else {
          currentLine = testLine;
        }
      }
      
      if (currentLine) {
        lineCount++;
      }
      
      totalLines += lineCount;
    });
    
    return totalLines;
  }
  
  // ç”Ÿæˆé¢„è§ˆ
  function generatePreview() {
    // å…ˆè§£æå†…å®¹
    if (!parseContent()) {
      alert('è¯·å…ˆç²˜è´´å†…å®¹ï¼');
      return;
    }
    
    if (!parsedData.title && !parsedData.description && !parsedData.analysis && !parsedData.note) {
      alert('æœªèƒ½è§£æåˆ°æœ‰æ•ˆå†…å®¹ï¼Œè¯·æ£€æŸ¥æ ¼å¼ï¼');
      return;
    }
    
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // è·å–é…ç½®
    const canvasWidth = parseInt(document.getElementById('canvasWidth').value);
    const padding = 40;
    const maxWidth = canvasWidth - padding * 2;
    
    const titleFontSize = parseInt(document.getElementById('titleFontSize').value);
    const descriptionFontSize = parseInt(document.getElementById('descriptionFontSize').value);
    const analysisFontSize = parseInt(document.getElementById('analysisFontSize').value);
    const noteFontSize = parseInt(document.getElementById('noteFontSize').value);
    
    const titleColor = document.getElementById('titleColor').value;
    const descriptionColor = document.getElementById('descriptionColor').value;
    const analysisColor = document.getElementById('analysisColor').value;
    const noteColor = document.getElementById('noteColor').value;
    const bgColor = document.getElementById('bgColor').value;
    
    const isArabic = document.getElementById('isArabic').checked;
    const textAlign = isArabic ? 'right' : 'left';
    const textX = isArabic ? canvasWidth - padding : padding;
    
    // è®¡ç®—æ€»é«˜åº¦
    let totalHeight = 0;
    
    // å¤´å›¾é«˜åº¦
    if (headerImg && headerImg.complete) {
      const headerHeight = (headerImg.height / headerImg.width) * canvasWidth;
      totalHeight += headerHeight;
    }
    
    // åˆ†æå›¾é«˜åº¦
    if (chartImg && chartImg.complete) {
      const chartHeight = (chartImg.height / chartImg.width) * canvasWidth;
      totalHeight += chartHeight + 30;
    }
    
    // æ–‡æœ¬é«˜åº¦ä¼°ç®—
    const maxTextWidth = canvasWidth - padding * 2;
    
    if (parsedData.title) {
      const titleLines = calculateWrappedLines(parsedData.title, titleFontSize, maxTextWidth);
      totalHeight += titleFontSize * 1.8 * titleLines + 40;
    }
    if (parsedData.description) {
      const descLines = calculateWrappedLines(parsedData.description, descriptionFontSize, maxTextWidth);
      totalHeight += descriptionFontSize * 1.8 * descLines + 40;
    }
    if (parsedData.analysis) {
      const analysisLines = calculateWrappedLines(parsedData.analysis, analysisFontSize, maxTextWidth);
      totalHeight += analysisFontSize * 1.8 * analysisLines + 40;
    }
    if (parsedData.note) {
      const noteLines = calculateWrappedLines(parsedData.note, noteFontSize, maxTextWidth);
      totalHeight += noteFontSize * 1.8 * noteLines + 40;
    }
    
    // è®¾ç½®ç”»å¸ƒå°ºå¯¸
    canvas.width = canvasWidth;
    canvas.height = totalHeight;
    
    // å¡«å……èƒŒæ™¯
    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    let currentY = 0;
    
    // ç»˜åˆ¶å¤´å›¾
    if (headerImg && headerImg.complete) {
      const headerHeight = (headerImg.height / headerImg.width) * canvasWidth;
      ctx.drawImage(headerImg, 0, currentY, canvasWidth, headerHeight);
      currentY += headerHeight;
    }
    
    // ç»˜åˆ¶åˆ†æå›¾
    if (chartImg && chartImg.complete) {
      const chartHeight = (chartImg.height / chartImg.width) * canvasWidth;
      ctx.drawImage(chartImg, 0, currentY, canvasWidth, chartHeight);
      currentY += chartHeight;
    }
    
    // è®¾ç½®æ–‡æœ¬å¯¹é½
    ctx.textAlign = textAlign;
    ctx.direction = isArabic ? 'rtl' : 'ltr';
    
    // ç»˜åˆ¶æ ‡é¢˜
    if (parsedData.title) {
      ctx.font = `bold ${titleFontSize}px Arial, sans-serif`;
      ctx.fillStyle = titleColor;
      currentY = wrapText(ctx, parsedData.title, textX, currentY + titleFontSize, maxWidth, titleFontSize * 1.5, textAlign);
      currentY += 30;
    }
    
    // ç»˜åˆ¶æè¿°
    if (parsedData.description) {
      ctx.font = `${descriptionFontSize}px Arial, sans-serif`;
      ctx.fillStyle = descriptionColor;
      currentY = wrapText(ctx, parsedData.description, textX, currentY + descriptionFontSize, maxWidth, descriptionFontSize * 1.5, textAlign);
      currentY += 30;
    }
    
    // ç»˜åˆ¶åˆ†æ
    if (parsedData.analysis) {
      ctx.font = `${analysisFontSize}px Arial, sans-serif`;
      ctx.fillStyle = analysisColor;
      currentY = wrapText(ctx, parsedData.analysis, textX, currentY + analysisFontSize, maxWidth, analysisFontSize * 1.5, textAlign);
      currentY += 30;
    }
    
    // ç»˜åˆ¶æ³¨æ„äº‹é¡¹
    if (parsedData.note) {
      ctx.font = `italic ${noteFontSize}px Arial, sans-serif`;
      ctx.fillStyle = noteColor;
      currentY = wrapText(ctx, parsedData.note, textX, currentY + noteFontSize, maxWidth, noteFontSize * 1.5, textAlign);
    }
    
    // æ˜¾ç¤ºé¢„è§ˆ
    const preview = document.getElementById('preview');
    preview.innerHTML = '';
    const previewCanvas = document.createElement('canvas');
    previewCanvas.width = canvas.width;
    previewCanvas.height = canvas.height;
    previewCanvas.className = 'preview-canvas';
    const previewCtx = previewCanvas.getContext('2d');
    previewCtx.drawImage(canvas, 0, 0);
    preview.appendChild(previewCanvas);
    
    console.log('é¢„è§ˆç”ŸæˆæˆåŠŸ');
  }
  
  // å¯¼å‡ºå›¾ç‰‡
  function exportImage() {
    // å¯¼å‡ºå‰é‡æ–°è§£æå’Œç”Ÿæˆ
    if (!parseContent()) {
      alert('è¯·å…ˆç²˜è´´å†…å®¹ï¼');
      return;
    }
    
    // é‡æ–°ç”Ÿæˆç”»å¸ƒï¼ˆä¸æ˜¾ç¤ºé¢„è§ˆï¼‰
    generatePreview();
    
    const canvas = document.getElementById('canvas');
    if (canvas.width === 0 || canvas.height === 0) {
      alert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥å†…å®¹ï¼');
      return;
    }
    
    try {
      const link = document.createElement('a');
      const timestamp = new Date().getTime();
      link.download = `market-analysis-${timestamp}.png`;
      link.href = canvas.toDataURL('image/png', 1.0);
      link.click();
      console.log('å›¾ç‰‡å¯¼å‡ºæˆåŠŸ');
    } catch (e) {
      console.error('å¯¼å‡ºå¤±è´¥', e);
      alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }
  
  // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
  window.addEventListener('load', function() {
    loadHistory();
  });
</script>
</body>
</html>
