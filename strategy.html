<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç­–ç•¥å›¾ç‰‡ç”Ÿæˆå™¨</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      
      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          padding: 20px;
          min-height: 100vh;
      }
      
      .container {
          max-width: 1400px;
          margin: 0 auto;
          display: grid;
          grid-template-columns: 450px 1fr;
          gap: 20px;
      }
      
      .panel {
          background: white;
          border-radius: 12px;
          padding: 25px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      }
      
      h2 {
          color: #333;
          margin-bottom: 20px;
          font-size: 20px;
          border-bottom: 2px solid #667eea;
          padding-bottom: 10px;
      }
      
      .form-group {
          margin-bottom: 15px;
      }
      
      label {
          display: block;
          margin-bottom: 5px;
          color: #555;
          font-weight: 600;
          font-size: 13px;
      }
      
      input, select {
          width: 100%;
          padding: 10px;
          border: 2px solid #e0e0e0;
          border-radius: 6px;
          font-size: 14px;
          transition: border-color 0.3s;
      }
      
      input:focus, select:focus {
          outline: none;
          border-color: #667eea;
      }
      
      .row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
      }
      
      .color-input-group {
          display: flex;
          gap: 8px;
          align-items: center;
      }
      
      .color-btn {
          padding: 8px 12px;
          margin: 0;
          height: 38px;
          width: auto;
          font-size: 13px;
          background: #667eea;
      }
      
      input[type="color"] {
          width: 50px;
          height: 38px;
          border: none;
          cursor: pointer;
      }
      
      input[type="file"] {
          padding: 8px;
      }
      
      button {
          width: 100%;
          padding: 12px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 6px;
          font-size: 15px;
          font-weight: 600;
          cursor: pointer;
          transition: transform 0.2s;
          margin-top: 10px;
      }
      
      button:hover {
          transform: translateY(-2px);
      }
      
      button:active {
          transform: translateY(0);
      }
      
      .preview-section {
          display: flex;
          flex-direction: column;
          align-items: center;
      }
      
      #canvas {
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          max-width: 100%;
          box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      }
      
      .download-btn {
          margin-top: 15px;
          background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      }
      
      .style-section {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 15px;
      }
      
      .style-section h3 {
          font-size: 14px;
          color: #667eea;
          margin-bottom: 12px;
      }
      
      .quick-colors {
          display: flex;
          gap: 8px;
          margin-top: 8px;
      }
      
      .quick-color {
          width: 30px;
          height: 30px;
          border-radius: 4px;
          cursor: pointer;
          border: 2px solid transparent;
          transition: all 0.2s;
      }
      
      .quick-color:hover {
          border-color: #667eea;
          transform: scale(1.1);
      }
  </style>
</head>
<body>
  <div class="container">
      <!-- å·¦ä¾§è¾“å…¥é¢æ¿ -->
      <div class="panel">
          <h2>ğŸ“Š ç­–ç•¥å‚æ•°è¾“å…¥</h2>
          
          <div class="form-group">
              <label>ç­–ç•¥ç¼–å· (Strategy ID)</label>
              <input type="text" id="strategy_id" value="209898" placeholder="ä¾‹å¦‚: 209898">
          </div>
          
          <div class="form-group">
              <label>äº¤æ˜“æ ‡çš„ (Symbol Name)</label>
              <input type="text" id="symbol_name" value="BTC" placeholder="ä¾‹å¦‚: BTC æˆ– ETH">
          </div>
          
          <div class="form-group">
              <label>æ“ä½œæ–¹å‘ (Direction)</label>
              <select id="direction">
                  <option value="long">Long</option>
                  <option value="short">Short</option>
              </select>
          </div>
          
          <div class="form-group">
              <label>åŸºç¡€è¿›åœºä»· (Entry Price)</label>
              <input type="number" id="entry_price" value="110947" placeholder="ä¾‹å¦‚: 110947">
          </div>
          
          <div class="form-group">
              <label>è¯­è¨€é€‰æ‹©</label>
              <select id="language">
                  <option value="en">English (è‹±è¯­)</option>
                  <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹ (ä¿„è¯­)</option>
                  <option value="vi">Tiáº¿ng Viá»‡t (è¶Šå—è¯­)</option>
                  <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (é˜¿æ‹‰ä¼¯è¯­)</option>
              </select>
          </div>
          
          <div class="style-section">
              <h3>ğŸ¨ æ–‡å­—æ ·å¼</h3>
              
              <div class="row">
                  <div class="form-group">
                      <label>å­—ä½“å¤§å°</label>
                      <input type="number" id="fontSize" value="25" min="12" max="36">
                  </div>
                  <div class="form-group">
                      <label>å¯¼å‡ºåˆ†è¾¨ç‡å€æ•°</label>
                      <input type="number" id="exportScale" value="2" min="1" max="5" step="0.5">
                  </div>
              </div>
              
              <div class="form-group">
                  <label>æ–‡å­—é¢œè‰²</label>
                  <div class="color-input-group">
                      <input type="color" id="textColor" value="#ffffff">
                      <input type="text" id="textColorHex" value="#ffffff" placeholder="#ffffff">
                      <button class="color-btn" onclick="applyColor('text')">ç¡®å®š</button>
                  </div>
                  <div class="quick-colors">
                      <div class="quick-color" style="background: #ffffff" onclick="setColor('text', '#ffffff')"></div>
                      <div class="quick-color" style="background: #000000" onclick="setColor('text', '#000000')"></div>
                      <div class="quick-color" style="background: #667eea" onclick="setColor('text', '#667eea')"></div>
                      <div class="quick-color" style="background: #38ef7d" onclick="setColor('text', '#38ef7d')"></div>
                      <div class="quick-color" style="background: #ffd700" onclick="setColor('text', '#ffd700')"></div>
                  </div>
              </div>
              
              <div class="form-group">
                  <label>æ–‡å­—èƒŒæ™¯é¢œè‰²</label>
                  <div class="color-input-group">
                      <input type="color" id="textBgColor" value="#1a1a2e">
                      <input type="text" id="textBgColorHex" value="#1a1a2e" placeholder="#1a1a2e">
                      <button class="color-btn" onclick="applyColor('textBg')">ç¡®å®š</button>
                  </div>
                  <div class="quick-colors">
                      <div class="quick-color" style="background: #1a1a2e" onclick="setColor('textBg', '#1a1a2e')"></div>
                      <div class="quick-color" style="background: #2d3436" onclick="setColor('textBg', '#2d3436')"></div>
                      <div class="quick-color" style="background: #0f3460" onclick="setColor('textBg', '#0f3460')"></div>
                      <div class="quick-color" style="background: rgba(0,0,0,0.7)" onclick="setColor('textBg', 'rgba(0,0,0,0.7)')"></div>
                  </div>
              </div>
              
              <div class="row">
                  <div class="form-group">
                      <label>èƒŒæ™¯åœ†è§’</label>
                      <input type="number" id="bgRadius" value="15" min="0" max="50">
                  </div>
                  <div class="form-group">
                      <label>èƒŒæ™¯é€æ˜åº¦</label>
                      <input type="number" id="bgOpacity" value="1" min="0" max="1" step="0.1">
                  </div>
              </div>
          </div>
          
          <div class="form-group">
              <label>ä¸Šä¼ å¤´å›¾ (Header Image)</label>
              <input type="file" id="headerImage" accept="image/*">
          </div>
          
          <button onclick="generateImage()">ğŸ¨ ç”Ÿæˆç­–ç•¥å›¾ç‰‡</button>
      </div>
      
      <!-- å³ä¾§é¢„è§ˆé¢æ¿ -->
      <div class="panel preview-section">
          <h2>ğŸ–¼ï¸ é¢„è§ˆæ•ˆæœ</h2>
          <canvas id="canvas" width="800" height="1000"></canvas>
          <button class="download-btn" onclick="downloadImage()">â¬‡ï¸ ä¸‹è½½å›¾ç‰‡</button>
      </div>
  </div>

  <script>
      // è¯­è¨€æ¨¡æ¿
      const templates = {
          en: {
              title: "âœ… Strategy ID {strategy_id}",
              lines: [
                  "{symbol_name} (Total Position {total_position_pct}%)",
                  "Entry Range: {price_low} â€“ {price_high}",
                  "Direction: {direction}",
                  "Max Position Size: {total_position_pct}%",
                  "Leverage: {leverage}x",
                  "Partial Take-Profit Prices: {tp1} / {tp2} / {tp3}",
                  "Stop Loss: {sl}"
              ],
              align: "left",
              font: "Arial, sans-serif"
              ,directionLabels: { long: 'Long', short: 'Short' }
          },
          ru: {
              title: "âœ… Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ â„–{strategy_id}",
              lines: [
                  "{symbol_name} (ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¾Ğ±ÑŠÑ‘Ğ¼ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ {total_position_pct}%)",
                  "Ğ”Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ Ğ²Ñ…Ğ¾Ğ´Ğ°: {price_low} â€“ {price_high}",
                  "ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: {direction}",
                  "ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸: {total_position_pct}%",
                  "ĞŸĞ»ĞµÑ‡Ğ¾: {leverage}x",
                  "Ğ¦ĞµĞ½Ñ‹ Ñ‡Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğ¹ Ñ„Ğ¸ĞºÑĞ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»Ğ¸: {tp1} / {tp2} / {tp3}",
                  "Ğ¡Ñ‚Ğ¾Ğ¿-Ğ»Ğ¾ÑÑ: {sl}"
              ],
              align: "left",
              font: "Arial, sans-serif"
              ,directionLabels: { long: 'Ğ”Ğ»Ğ¸Ğ½Ğ½Ğ°Ñ', short: 'ĞšĞ¾Ñ€Ğ¾Ñ‚ĞºĞ°Ñ' }
          },
          vi: {
              title: "âœ… Chiáº¿n lÆ°á»£c sá»‘ {strategy_id}",
              lines: [
                  "{symbol_name} (Tá»•ng vá»‹ tháº¿ {total_position_pct}%)",
                  "VÃ¹ng vÃ o lá»‡nh: {price_low} â€“ {price_high}",
                  "HÆ°á»›ng giao dá»‹ch: {direction}",
                  "Giá»›i háº¡n vá»‹ tháº¿: {total_position_pct}%",
                  "ÄÃ²n báº©y: {leverage}x",
                  "GiÃ¡ chá»‘t lá»i tá»«ng pháº§n: {tp1} / {tp2} / {tp3}",
                  "Cáº¯t lá»—: {sl}"
              ],
              align: "left",
              font: "Arial, sans-serif"
              ,directionLabels: { long: 'Mua (Long)', short: 'BÃ¡n (Short)' }
          },
          ar: {
              title: "âœ… Ø±Ù‚Ù… Ø§Ù„Ø¥Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© {strategy_id}",
              lines: [
                  "{symbol_name} (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø¬Ù… Ø§Ù„ØµÙÙ‚Ø© {total_position_pct}%)",
                  "Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¯Ø®ÙˆÙ„: {price_low} â€“ {price_high}",
                  "Ø§Ù„Ø§ØªØ¬Ø§Ù‡: {direction}",
                  "Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø­Ø¬Ù… Ø§Ù„ØµÙÙ‚Ø©: {total_position_pct}%",
                  "Ø§Ù„Ø±Ø§ÙØ¹Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©: {leverage}x",
                  "Ø£Ø³Ø¹Ø§Ø± Ø¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©: {tp1} / {tp2} / {tp3}",
                  "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©: {sl}"
              ],
              align: "right",
              font: "Arial, sans-serif"
              ,directionLabels: { long: 'Ø´Ø±Ø§Ø¡', short: 'Ø¨ÙŠØ¹' }
          }
      };

      let headerImageData = null;

      // è®¡ç®—ç­–ç•¥å‚æ•°
      function calculateStrategy(symbolName, entryPrice, direction) {
          const symbol = symbolName.toUpperCase();
          const offset = symbol.includes('BTC') ? 100 : 10;
          
          // åˆ¤æ–­æ˜¯å¤šå•è¿˜æ˜¯ç©ºå•
          const isLong = direction === 'long';
          
          return {
              price_low: Math.round(entryPrice - offset),    // BTC: entry_price-100, ETH: entry_price-10
              price_high: Math.round(entryPrice + offset),   // BTC: entry_price+100, ETH: entry_price+10
              leverage: 100,                                 // å›ºå®šå€¼
              total_position_pct: 5,                         // å›ºå®šå€¼
              // å¤šå•ï¼šå‘ä¸Šæ­¢ç›ˆï¼Œå‘ä¸‹æ­¢æŸ
              // ç©ºå•ï¼šå‘ä¸‹æ­¢ç›ˆï¼Œå‘ä¸Šæ­¢æŸ
              tp1: isLong ? 
                  Math.round(entryPrice * (1 + 0.012)) :    // å¤šå•ï¼šentry_price Ã— (1+0.012)
                  Math.round(entryPrice * (1 - 0.012)),     // ç©ºå•ï¼šentry_price Ã— (1-0.012)
              tp2: isLong ? 
                  Math.round(entryPrice * (1 + 0.018)) :    // å¤šå•ï¼šentry_price Ã— (1+0.018)
                  Math.round(entryPrice * (1 - 0.018)),     // ç©ºå•ï¼šentry_price Ã— (1-0.018)
              tp3: isLong ? 
                  Math.round(entryPrice * (1 + 0.03)) :     // å¤šå•ï¼šentry_price Ã— (1+0.03)
                  Math.round(entryPrice * (1 - 0.03)),      // ç©ºå•ï¼šentry_price Ã— (1-0.03)
              sl: isLong ? 
                  Math.round(entryPrice * (1 - 0.01)) :     // å¤šå•ï¼šentry_price Ã— (1-0.01)
                  Math.round(entryPrice * (1 + 0.01))       // ç©ºå•ï¼šentry_price Ã— (1+0.01)
          };
      }

      // é¢œè‰²é€‰æ‹©å™¨åŒæ­¥ä¸åº”ç”¨
      document.getElementById('textColor').addEventListener('input', (e) => {
          document.getElementById('textColorHex').value = e.target.value;
          generateImage(); // é¢œè‰²é€‰æ‹©å™¨å˜åŒ–æ—¶å®æ—¶é¢„è§ˆ
      });
      
      document.getElementById('textBgColor').addEventListener('input', (e) => {
          document.getElementById('textBgColorHex').value = e.target.value;
          generateImage(); // é¢œè‰²é€‰æ‹©å™¨å˜åŒ–æ—¶å®æ—¶é¢„è§ˆ
      });
      
      // ç¡®è®¤æŒ‰é’®åº”ç”¨é¢œè‰²
      function applyColor(type) {
          const hexInput = document.getElementById(type === 'text' ? 'textColorHex' : 'textBgColorHex');
          const colorPicker = document.getElementById(type === 'text' ? 'textColor' : 'textBgColor');
          
          // éªŒè¯é¢œè‰²æ ¼å¼
          const colorRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
          let color = hexInput.value.trim();
          
          // å¦‚æœæ²¡æœ‰#å·ï¼Œæ·»åŠ #å·
          if (!color.startsWith('#')) {
              color = '#' + color;
          }
          
          // éªŒè¯é¢œè‰²å€¼
          if (colorRegex.test(color)) {
              colorPicker.value = color;
              hexInput.value = color;
              generateImage(); // åº”ç”¨æ–°é¢œè‰²å¹¶é‡æ–°ç”Ÿæˆå›¾ç‰‡
          } else {
              alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¢œè‰²å€¼ï¼Œä¾‹å¦‚: #FF0000');
              // æ¢å¤ä¸ºé¢œè‰²é€‰æ‹©å™¨çš„å½“å‰å€¼
              hexInput.value = colorPicker.value;
          }
      }

      // å½“è¯­è¨€æ”¹å˜æ—¶ï¼Œæ›´æ–° direction é€‰é¡¹æ–‡æœ¬ä¸ºå¯¹åº”è¯­è¨€
      function updateDirectionLabels() {
          const lang = document.getElementById('language').value;
          const tpl = templates[lang] || templates['en'];
          const labels = tpl.directionLabels || { long: 'Long', short: 'Short' };
          const sel = document.getElementById('direction');
          // ä¿ç•™å½“å‰é€‰ä¸­å€¼
          const current = sel.value;
          sel.innerHTML = '';
          const optLong = document.createElement('option');
          optLong.value = 'long';
          optLong.textContent = labels.long;
          const optShort = document.createElement('option');
          optShort.value = 'short';
          optShort.textContent = labels.short;
          sel.appendChild(optLong);
          sel.appendChild(optShort);
          // æ¢å¤ä¹‹å‰çš„é€‰æ‹©ï¼ˆè‹¥ä»å¯ç”¨ï¼‰
          if (current === 'long' || current === 'short') sel.value = current;
      }

      document.getElementById('language').addEventListener('change', () => {
          updateDirectionLabels();
      });

      // å¿«é€Ÿé¢œè‰²é€‰æ‹©
      function setColor(type, color) {
          if (type === 'text') {
              document.getElementById('textColor').value = color;
              document.getElementById('textColorHex').value = color;
          } else {
              document.getElementById('textBgColor').value = color;
              document.getElementById('textBgColorHex').value = color;
          }
      }

      // ä¸Šä¼ å¤´å›¾
      document.getElementById('headerImage').addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
              const reader = new FileReader();
              reader.onload = (event) => {
                  const img = new Image();
                  img.onload = () => {
                      headerImageData = img;
                      generateImage();
                  };
                  img.src = event.target.result;
              };
              reader.readAsDataURL(file);
          }
      });

      // ç”Ÿæˆå›¾ç‰‡ï¼ˆå¯é€‰ï¼šä¼ å…¥ targetCanvas ä¸ scale ä»¥ç”Ÿæˆæ›´é«˜æ¸…çš„å¯¼å‡ºç”»å¸ƒï¼‰
      function generateImage(targetCanvas = null, scale = 1) {
          const canvas = targetCanvas || document.getElementById('canvas');

          // è·å–è¾“å…¥å€¼
          const strategyId = document.getElementById('strategy_id').value;
          const symbolName = document.getElementById('symbol_name').value;
          const direction = document.getElementById('direction').value;
          const entryPrice = parseFloat(document.getElementById('entry_price').value);
          const language = document.getElementById('language').value;
          
          // æ ·å¼å‚æ•°
          const fontSize = parseInt(document.getElementById('fontSize').value);
          const textColor = document.getElementById('textColor').value;
          const textBgColor = document.getElementById('textBgColor').value;
          const bgRadius = parseInt(document.getElementById('bgRadius').value);
          const bgOpacity = parseFloat(document.getElementById('bgOpacity').value);

          // è®¡ç®—ç­–ç•¥å‚æ•°
          const calculated = calculateStrategy(symbolName, entryPrice, direction);
          
          // å‡†å¤‡æ•°æ®
          const data = {
              strategy_id: strategyId,
              symbol_name: symbolName,
              direction: direction,
              entry_price: entryPrice,
              ...calculated
          };
          
          // è·å–æ¨¡æ¿
          const template = templates[language] || templates['en'];

          // å°† direction å†…éƒ¨å€¼æ˜ å°„ä¸ºæ¨¡æ¿è¯­è¨€çš„æ˜¾ç¤ºæ–‡æœ¬ï¼ˆlong/short -> æœ¬åœ°åŒ–å­—ç¬¦ä¸²ï¼‰
          const dirValue = document.getElementById('direction').value; // 'long' or 'short'
          const localizedDirection = (template.directionLabels && template.directionLabels[dirValue]) ? template.directionLabels[dirValue] : (dirValue === 'long' ? 'Long' : 'Short');
          
          // æŠŠæœ¬åœ°åŒ– direction æ”¾å…¥ data ä¸­ï¼Œè¿™æ ·æ¨¡æ¿æ›¿æ¢ {direction} æ—¶ä¼šä½¿ç”¨æ­£ç¡®è¯­è¨€
          data.direction = localizedDirection;

          // å…ˆè®¡ç®—éœ€è¦çš„é«˜åº¦ï¼ˆä¸æ”¹å˜ç°æœ‰ canvas å†…å®¹ï¼‰
          const scaleFactor = scale || 1;
          const paddingScaled = Math.round(30 * scaleFactor);
          const fontSizeScaled = Math.round(fontSize * scaleFactor);
          const titleFontScaled = Math.round((fontSize + 4) * scaleFactor);
          const lineHeight = fontSizeScaled * 1.8;
          const titleText = template && template.title ? template.title.replace(/{(\w+)}/g, (m,k) => data[k] || m) : '';
          const contentLines = template && template.lines ? template.lines.map(line => line.replace(/{(\w+)}/g, (m,k) => data[k] || m)) : [];

          const bgHeight = Math.round(lineHeight * (contentLines.length + 2) + paddingScaled * 2);

          // å¤´å›¾é«˜åº¦é¢„æµ‹ï¼ˆè‹¥æœ‰å¤´å›¾ï¼‰
          const canvasWidth = canvas.width;
          let headerDrawHeight = 0;
          let topSpacing = 0; // è‹¥æ— å¤´å›¾ï¼Œç”¨ä½œé¡¶éƒ¨ç©ºç™½
          if (headerImageData) {
              const imgAspect = headerImageData.width / headerImageData.height;
              headerDrawHeight = Math.round(canvasWidth / imgAspect);
              topSpacing = 0;
          } else {
              headerDrawHeight = 0;
              topSpacing = Math.round(50 * scaleFactor); // ä¿æŒä¸ä¹‹å‰ä¸€è‡´çš„é»˜è®¤é¡¶éƒ¨ç©ºç™½ï¼Œå¹¶éš scale ç¼©æ”¾
          }

          const bottomPadding = 40;
          const totalHeight = topSpacing + headerDrawHeight + bgHeight + bottomPadding;

          // è®¾ç½® canvas é«˜åº¦ï¼ˆä¼šé‡ç½®ç”»å¸ƒçŠ¶æ€ï¼‰ï¼Œç„¶åé‡æ–°è·å– ctx
          canvas.height = Math.max(totalHeight, 200);
          const ctx = canvas.getContext('2d', { alpha: false });
          
          // é’ˆå¯¹é«˜åˆ†è¾¨ç‡å¯¼å‡ºä¼˜åŒ–æ¸²æŸ“è®¾ç½®
          if (scale > 1) {
              // å¯¹äºé«˜åˆ†è¾¨ç‡å¯¼å‡ºï¼Œç¦ç”¨å¹³æ»‘ä»¥å®ç°ç‚¹å¯¹ç‚¹æ¸²æŸ“
              ctx.imageSmoothingEnabled = false;
              // è®¾ç½®æ–‡å­—æ¸²æŸ“ä¼˜åŒ–
              ctx.textRendering = "geometricPrecision";
              ctx.fontKerning = "normal";
          } else {
              // é¢„è§ˆæ—¶ä¿æŒå¹³æ»‘
              ctx.imageSmoothingEnabled = true;
          }

          // æ¸…ç©ºç”»å¸ƒ â€” ä½¿ç”¨æ–‡å­—èƒŒæ™¯è‰²ä½œä¸ºç”»å¸ƒåº•è‰²ä»¥å‡å°‘åŠé€æ˜å±‚å æ—¶çš„è‰²å·®æ¥ç¼
          ctx.fillStyle = textBgColor || '#f0f0f0';
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // ç»˜åˆ¶å¤´å›¾ï¼ˆè‹¥æœ‰ï¼‰ï¼Œå¹¶ç´§è´´åç»­å†…å®¹ï¼ˆä¸é¢å¤–å¢åŠ é—´éš™ï¼‰
          let currentY = topSpacing;
          if (headerImageData) {
              const headerWidth = canvas.width;
              const drawHeight = headerDrawHeight;
              ctx.drawImage(headerImageData, 0, 0, headerWidth, drawHeight);
              currentY += drawHeight; // ç›´æ¥ç´§è´´
          }

          // ç»˜åˆ¶æ–‡å­—èƒŒæ™¯
          const bgY = Math.round(currentY);
          // ç»˜åˆ¶åœ†è§’çŸ©å½¢èƒŒæ™¯
          ctx.globalAlpha = bgOpacity;
          ctx.fillStyle = textBgColor;
          const bgRadiusScaled = Math.round(bgRadius * scaleFactor);
          roundRect(ctx, paddingScaled, bgY, canvas.width - paddingScaled * 2, bgHeight, bgRadiusScaled);
          ctx.fill();
          ctx.globalAlpha = 1;

          // è®¾ç½®æ–‡å­—æ ·å¼ï¼ˆä½¿ç”¨ç¼©æ”¾åçš„å­—ä½“å°ºå¯¸ï¼‰
          ctx.fillStyle = textColor;
          ctx.font = `bold ${titleFontScaled}px ${template.font}`;
          ctx.textAlign = template.align;
          
          const textX = template.align === 'right' ? canvas.width - paddingScaled - Math.round(20 * scaleFactor) : paddingScaled + Math.round(20 * scaleFactor);
          let textY = bgY + paddingScaled + fontSizeScaled + Math.round(10 * scaleFactor);

          // ç»˜åˆ¶æ ‡é¢˜
          ctx.fillText(titleText.replace(/{(\w+)}/g, (m,k) => data[k] || m), textX, textY);

          // ç»˜åˆ¶å†…å®¹
          ctx.font = `${fontSizeScaled}px ${template.font}`;
          textY += lineHeight * 1.5;
          contentLines.forEach((line, index) => {
              // åˆ¤æ–­æ˜¯å¦æ˜¯ Direction è¡Œ
              if (line.includes(localizedDirection)) {
                  // ä¿å­˜å½“å‰é¢œè‰²
                  const originalColor = ctx.fillStyle;
                  // æ ¹æ®æ–¹å‘è®¾ç½®é¢œè‰²
                  if (direction === 'long') {
                      ctx.fillStyle = '#00DA90'; // å¤šå¤´ç»¿è‰²
                  } else if (direction === 'short') {
                      ctx.fillStyle = '#F04343'; // ç©ºå¤´çº¢è‰²
                  }
                  ctx.fillText(line, textX, textY);
                  // æ¢å¤åŸæ¥çš„é¢œè‰²
                  ctx.fillStyle = originalColor;
              } else {
                  ctx.fillText(line, textX, textY);
              }
              textY += lineHeight;
          });
      }

      // ç»˜åˆ¶åœ†è§’çŸ©å½¢
      function roundRect(ctx, x, y, width, height, radius) {
          ctx.beginPath();
          ctx.moveTo(x + radius, y);
          ctx.lineTo(x + width - radius, y);
          ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
          ctx.lineTo(x + width, y + height - radius);
          ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
          ctx.lineTo(x + radius, y + height);
          ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
          ctx.lineTo(x, y + radius);
          ctx.quadraticCurveTo(x, y, x + radius, y);
          ctx.closePath();
      }

      // ä¸‹è½½å›¾ç‰‡ â€” ä»¥æ›´é«˜åˆ†è¾¨ç‡é‡æ–°æ¸²æŸ“åŸå§‹é•¿å›¾ï¼ˆä¿æŒé•¿å›¾æ¯”ä¾‹ä¸å˜ï¼‰
      function downloadImage() {
          const preview = document.getElementById('canvas');
          const baseW = preview.width;
          const baseH = preview.height;

          // ä»è¾“å…¥æ¡†è·å–å¯¼å‡ºåˆ†è¾¨ç‡å€æ•°
          const exportScale = parseFloat(document.getElementById('exportScale').value) || 2;

          // åˆ›å»ºä¸€ä¸ªç”¨äºé«˜åˆ†è¾¨ç‡æ¸²æŸ“çš„ä¸´æ—¶ç”»å¸ƒ
          const temp = document.createElement('canvas');
          temp.width = Math.round(baseW * exportScale);
          temp.height = Math.round(baseH * exportScale);

          // ä½¿ç”¨ generateImage åœ¨ä¸´æ—¶ç”»å¸ƒä¸Šä»¥ exportScale é‡ç»˜ï¼ˆå‘é‡æ–¹å¼æ¸²æŸ“ï¼Œæ–‡å­—æ›´æ¸…æ™°ï¼‰
          generateImage(temp, exportScale);

          // å¯¼å‡º PNG
          const link = document.createElement('a');
          const strategyId = document.getElementById('strategy_id').value;
          link.download = `strategy_${strategyId}_x${exportScale}.png`;
          link.href = temp.toDataURL('image/png');
          link.click();
      }

      // åˆå§‹åŒ–ç”Ÿæˆ
      window.onload = () => {
          updateDirectionLabels();
          generateImage();
      };
  </script>
</body>
</html>