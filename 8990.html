<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>高级网页爬虫工具</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px;
      }

      .container {
          max-width: 1400px;
          margin: 0 auto;
          background: white;
          border-radius: 15px;
          box-shadow: 0 20px 40px rgba(0,0,0,0.1);
          overflow: hidden;
      }

      .header {
          background: linear-gradient(135deg, #2c3e50, #3498db);
          color: white;
          padding: 30px;
          text-align: center;
      }

      .header h1 {
          font-size: 2.5em;
          margin-bottom: 10px;
      }

      .header p {
          opacity: 0.9;
          font-size: 1.1em;
      }

      .main-content {
          padding: 30px;
      }

      .input-section {
          background: #f8f9fa;
          padding: 25px;
          border-radius: 10px;
          margin-bottom: 30px;
      }

      .form-group {
          margin-bottom: 20px;
      }

      label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #2c3e50;
      }

      input, select, textarea {
          width: 100%;
          padding: 12px;
          border: 2px solid #e0e6ed;
          border-radius: 8px;
          font-size: 16px;
          transition: border-color 0.3s;
      }

      input:focus, select:focus, textarea:focus {
          outline: none;
          border-color: #3498db;
      }

      .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
      }

      .form-row-3 {
          display: grid;
          grid-template-columns: 1fr 1fr 1fr;
          gap: 20px;
      }

      .checkbox-group {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
          margin-top: 10px;
      }

      .checkbox-item {
          display: flex;
          align-items: center;
          gap: 8px;
      }

      .checkbox-item input[type="checkbox"] {
          width: auto;
          margin: 0;
      }

      .btn {
          background: linear-gradient(135deg, #3498db, #2980b9);
          color: white;
          border: none;
          padding: 15px 30px;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          margin-right: 10px;
          margin-bottom: 10px;
      }

      .btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
      }

      .btn:disabled {
          background: #bdc3c7;
          cursor: not-allowed;
          transform: none;
          box-shadow: none;
      }

      .btn-secondary {
          background: linear-gradient(135deg, #95a5a6, #7f8c8d);
      }

      .btn-danger {
          background: linear-gradient(135deg, #e74c3c, #c0392b);
      }

      .btn-success {
          background: linear-gradient(135deg, #27ae60, #229954);
      }

      .btn-warning {
          background: linear-gradient(135deg, #f39c12, #e67e22);
      }

      .results-section {
          background: #f8f9fa;
          border-radius: 10px;
          padding: 25px;
          margin-top: 30px;
      }

      .status {
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-weight: 600;
      }

      .status.loading {
          background: #fff3cd;
          color: #856404;
          border: 1px solid #ffeaa7;
      }

      .status.success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .status.error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .status.paused {
          background: #e2e3e5;
          color: #383d41;
          border: 1px solid #d6d8db;
      }

      .progress-container {
          margin: 20px 0;
      }

      .progress-bar {
          width: 100%;
          height: 8px;
          background: #e0e6ed;
          border-radius: 4px;
          overflow: hidden;
          margin: 10px 0;
      }

      .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, #3498db, #2980b9);
          width: 0%;
          transition: width 0.3s;
      }

      .progress-text {
          display: flex;
          justify-content: space-between;
          font-size: 14px;
          color: #7f8c8d;
      }

      .stats {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
          gap: 20px;
          margin: 20px 0;
      }

      .stat-card {
          background: white;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      .stat-number {
          font-size: 2em;
          font-weight: bold;
          color: #3498db;
      }

      .stat-label {
          color: #7f8c8d;
          margin-top: 5px;
      }

      .data-preview {
          background: white;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          max-height: 500px;
          overflow: auto;
          margin-top: 20px;
      }

      .data-table {
          width: 100%;
          border-collapse: collapse;
          min-width: 800px;
      }

      .data-table th,
      .data-table td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #dee2e6;
          vertical-align: top;
      }

      .data-table th {
          background: #f8f9fa;
          font-weight: 600;
          color: #2c3e50;
          position: sticky;
          top: 0;
          z-index: 10;
      }

      .data-table tr:hover {
          background: #f8f9fa;
      }

      .description-cell {
          max-width: 300px;
          word-wrap: break-word;
          white-space: pre-wrap;
      }

      .url-cell {
          max-width: 200px;
          word-break: break-all;
      }

      .checkpoint-section {
          background: #e8f4f8;
          border: 1px solid #bee5eb;
          border-radius: 8px;
          padding: 20px;
          margin: 20px 0;
      }

      .checkpoint-info {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
      }

      .filter-section {
          background: #fff;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          padding: 20px;
          margin: 20px 0;
      }

      .filter-row {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
          margin-bottom: 15px;
      }

      @media (max-width: 768px) {
          .form-row, .form-row-3 {
              grid-template-columns: 1fr;
          }
          
          .header h1 {
              font-size: 2em;
          }
          
          .main-content {
              padding: 20px;
          }

          .data-table {
              font-size: 14px;
          }

          .data-table th,
          .data-table td {
              padding: 8px;
          }
      }

      .log-section {
          background: #2c3e50;
          color: #ecf0f1;
          border-radius: 8px;
          padding: 20px;
          margin-top: 20px;
          max-height: 300px;
          overflow-y: auto;
          font-family: 'Courier New', monospace;
          font-size: 14px;
      }

      .log-entry {
          margin-bottom: 5px;
          padding: 5px;
          border-radius: 3px;
      }

      .log-info { background: rgba(52, 152, 219, 0.2); }
      .log-success { background: rgba(39, 174, 96, 0.2); }
      .log-error { background: rgba(231, 76, 60, 0.2); }
      .log-warning { background: rgba(243, 156, 18, 0.2); }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>🕷️ 高级网页爬虫工具</h1>
          <p>支持断点续爬、用户关注数量、Channel简介等高级功能</p>
      </div>

      <div class="main-content">
          <div class="input-section">
              <h2>爬虫配置</h2>
              
              <div class="form-group">
                  <label for="url">目标网址</label>
                  <input type="url" id="url" placeholder="https://example.com" value="https://tgstat.com/tag/crypto">
              </div>

              <div class="form-row-3">
                  <div class="form-group">
                      <label for="scrapeType">爬取类型</label>
                      <select id="scrapeType">
                          <option value="tgstat">TGStat频道</option>
                          <option value="telegram">Telegram频道</option>
                          <option value="general">通用网页</option>
                          <option value="table">表格数据</option>
                          <option value="social">社交媒体</option>
                      </select>
                  </div>
                  
                  <div class="form-group">
                      <label for="maxPages">最大页数</label>
                      <input type="number" id="maxPages" value="10" min="1" max="100">
                  </div>

                  <div class="form-group">
                      <label for="delay">请求延迟(秒)</label>
                      <input type="number" id="delay" value="2" min="0.5" max="10" step="0.5">
                  </div>
              </div>

              <div class="form-group">
                  <label>数据提取选项</label>
                  <div class="checkbox-group">
                      <div class="checkbox-item">
                          <input type="checkbox" id="extractBasicInfo" checked>
                          <label for="extractBasicInfo">基本信息</label>
                      </div>
                      <div class="checkbox-item">
                          <input type="checkbox" id="extractSubscribers" checked>
                          <label for="extractSubscribers">订阅者/关注数</label>
                      </div>
                      <div class="checkbox-item">
                          <input type="checkbox" id="extractDescription" checked>
                          <label for="extractDescription">频道简介</label>
                      </div>
                      <div class="checkbox-item">
                          <input type="checkbox" id="extractActivity" checked>
                          <label for="extractActivity">活跃度信息</label>
                      </div>
                      <div class="checkbox-item">
                          <input type="checkbox" id="extractLinks" checked>
                          <label for="extractLinks">相关链接</label>
                      </div>
                      <div class="checkbox-item">
                          <input type="checkbox" id="extractMetadata">
                          <label for="extractMetadata">元数据</label>
                      </div>
                  </div>
              </div>

              <div class="form-row">
                  <div class="form-group">
                      <label for="outputFormat">输出格式</label>
                      <select id="outputFormat">
                          <option value="json">JSON</option>
                          <option value="csv">CSV</option>
                          <option value="excel">Excel</option>
                          <option value="xml">XML</option>
                      </select>
                  </div>
                  
                  <div class="form-group">
                      <label for="concurrency">并发数</label>
                      <input type="number" id="concurrency" value="3" min="1" max="10">
                  </div>
              </div>

              <div class="form-group">
                  <label for="customSelectors">自定义选择器 (可选)</label>
                  <textarea id="customSelectors" rows="3" placeholder="JSON格式: {&quot;title&quot;: &quot;.channel-title&quot;, &quot;subscribers&quot;: &quot;.subscribers-count&quot;}"></textarea>
              </div>

              <div class="checkpoint-section">
                  <div class="checkpoint-info">
                      <h3>断点续爬</h3>
                      <span id="checkpointStatus">无保存点</span>
                  </div>
                  <div class="form-group">
                      <button class="btn btn-success" onclick="loadCheckpoint()" id="loadCheckpointBtn" disabled>📂 加载断点</button>
                      <button class="btn btn-warning" onclick="saveCheckpoint()" id="saveCheckpointBtn" disabled>💾 保存断点</button>
                      <button class="btn btn-secondary" onclick="clearCheckpoint()">🗑️ 清除断点</button>
                  </div>
              </div>

              <div class="form-group">
                  <button class="btn" onclick="startScraping()" id="startBtn">🚀 开始爬取</button>
                  <button class="btn btn-secondary" onclick="pauseScraping()" id="pauseBtn" disabled>⏸️ 暂停</button>
                  <button class="btn btn-success" onclick="resumeScraping()" id="resumeBtn" disabled>▶️ 继续</button>
                  <button class="btn btn-danger" onclick="stopScraping()" id="stopBtn" disabled>⏹️ 停止</button>
              </div>
          </div>

          <div class="results-section">
              <h2>爬取结果</h2>
              
              <div id="status" class="status" style="display: none;">
                  准备开始爬取...
              </div>

              <div class="progress-container">
                  <div class="progress-text">
                      <span id="progressText">等待开始...</span>
                      <span id="progressPercentage">0%</span>
                  </div>
                  <div class="progress-bar">
                      <div class="progress-fill" id="progressFill"></div>
                  </div>
              </div>

              <div class="stats">
                  <div class="stat-card">
                      <div class="stat-number" id="totalItems">0</div>
                      <div class="stat-label">总条目数</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number" id="currentPage">0</div>
                      <div class="stat-label">当前页面</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number" id="successRate">0%</div>
                      <div class="stat-label">成功率</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number" id="timeElapsed">0s</div>
                      <div class="stat-label">耗时</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number" id="errorCount">0</div>
                      <div class="stat-label">错误数</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number" id="avgSubscribers">0</div>
                      <div class="stat-label">平均关注数</div>
                  </div>
              </div>

              <div class="filter-section">
                  <h3>数据筛选</h3>
                  <div class="filter-row">
                      <div class="form-group">
                          <label for="filterName">按名称筛选</label>
                          <input type="text" id="filterName" placeholder="输入关键词">
                      </div>
                      <div class="form-group">
                          <label for="filterMinSubscribers">最小关注数</label>
                          <input type="number" id="filterMinSubscribers" placeholder="0">
                      </div>
                      <div class="form-group">
                          <label for="filterMaxSubscribers">最大关注数</label>
                          <input type="number" id="filterMaxSubscribers" placeholder="无限制">
                      </div>
                      <div class="form-group">
                          <button class="btn" onclick="applyFilters()">🔍 应用筛选</button>
                          <button class="btn btn-secondary" onclick="clearFilters()">🔄 清除筛选</button>
                      </div>
                  </div>
              </div>

              <div class="data-preview">
                  <table class="data-table" id="dataTable">
                      <thead>
                          <tr>
                              <th>序号</th>
                              <th>频道名称</th>
                              <th>用户名</th>
                              <th>关注数</th>
                              <th>活跃度</th>
                              <th>简介</th>
                              <th>链接</th>
                              <th>状态</th>
                          </tr>
                      </thead>
                      <tbody id="dataTableBody">
                          <tr>
                              <td colspan="8" style="text-align: center; color: #7f8c8d; padding: 40px;">
                                  暂无数据，点击"开始爬取"开始工作
                              </td>
                          </tr>
                      </tbody>
                  </table>
              </div>

              <div class="form-group" style="margin-top: 20px;">
                  <button class="btn" onclick="downloadData()" id="downloadBtn" disabled>📥 下载数据</button>
                  <button class="btn btn-secondary" onclick="previewData()">👁️ 预览数据</button>
                  <button class="btn btn-secondary" onclick="exportFiltered()">📊 导出筛选结果</button>
                  <button class="btn btn-secondary" onclick="clearData()">🗑️ 清空数据</button>
                  <button class="btn btn-secondary" onclick="toggleLog()">📋 显示日志</button>
              </div>

              <div class="log-section" id="logSection" style="display: none;">
                  <h3>爬取日志</h3>
                  <div id="logContainer"></div>
              </div>
          </div>
      </div>
  </div>

  <script>
      let scrapingData = [];
      let filteredData = [];
      let isScrapingActive = false;
      let isPaused = false;
      let currentPageNum = 0;
      let startTime = null;
      let timerInterval = null;
      let errorCount = 0;
      let checkpointData = null;

      // 增强的模拟数据
      const enhancedSampleData = [
          { 
              name: "Hamster Kombat", 
              username: "@hamster_kombat", 
              subscribers: 53200000,
              subscribersText: "53.2M",
              activity: "12小时前",
              description: "🐹 Hamster Kombat - 最受欢迎的Telegram游戏！加入我们的仓鼠CEO世界，通过点击和升级来建立你的加密货币帝国。每天都有新的任务和奖励等着你！",
              url: "https://t.me/hamster_kombat",
              category: "游戏",
              verified: true
          },
          { 
              name: "Blum", 
              username: "@blumcrypto", 
              subscribers: 24100000,
              subscribersText: "24.1M",
              activity: "6小时前",
              description: "💎 Blum - 你的一站式加密货币交易应用。轻松购买、交易市场上的任何加密货币。简单、有趣的加密货币交易体验，适合所有用户。",
              url: "https://t.me/blumcrypto",
              category: "交易",
              verified: true
          },
          { 
              name: "Major", 
              username: "@majors", 
              subscribers: 18700000,
              subscribersText: "18.7M",
              activity: "2天前",
              description: "⭐ Major Community - 在评级中获得更高排名，现在就成为Telegram的Major！参与社区活动，赢取独家奖励和特权。",
              url: "https://t.me/majors",
              category: "社区",
              verified: true
          },
          { 
              name: "TapSwap", 
              username: "@tapswapai", 
              subscribers: 16700000,
              subscribersText: "16.7M",
              activity: "1天前",
              description: "🚀 TapSwap - 将你的无尽点击转化为金融工具。创新的点击挖矿游戏，让每一次点击都有价值。加入数百万用户的行列！",
              url: "https://t.me/tapswapai",
              category: "挖矿",
              verified: true
          },
          { 
              name: "X Empire", 
              username: "@x_empire_holders", 
              subscribers: 14500000,
              subscribersText: "14.5M",
              activity: "18小时前",
              description: "👑 X Empire - 欢迎来到官方X Empire频道！建立你的商业帝国，投资股票，成为亿万富翁。策略与运气的完美结合。",
              url: "https://t.me/x_empire_holders",
              category: "策略",
              verified: true
          }
      ];

      function log(message, type = 'info') {
          const timestamp = new Date().toLocaleTimeString();
          const logContainer = document.getElementById('logContainer');
          const logEntry = document.createElement('div');
          logEntry.className = `log-entry log-${type}`;
          logEntry.textContent = `[${timestamp}] ${message}`;
          logContainer.appendChild(logEntry);
          logContainer.scrollTop = logContainer.scrollHeight;
      }

      function updateStatus(message, type = 'loading') {
          const statusEl = document.getElementById('status');
          statusEl.textContent = message;
          statusEl.className = `status ${type}`;
          statusEl.style.display = 'block';
          log(message, type === 'loading' ? 'info' : type);
      }

      function updateProgress(percentage, text = '') {
          document.getElementById('progressFill').style.width = percentage + '%';
          document.getElementById('progressPercentage').textContent = Math.round(percentage) + '%';
          if (text) {
              document.getElementById('progressText').textContent = text;
          }
      }

      function updateStats(items, page, success, time, errors, avgSubs) {
          document.getElementById('totalItems').textContent = items.toLocaleString();
          document.getElementById('currentPage').textContent = page;
          document.getElementById('successRate').textContent = success + '%';
          document.getElementById('timeElapsed').textContent = time + 's';
          document.getElementById('errorCount').textContent = errors;
          document.getElementById('avgSubscribers').textContent = avgSubs > 1000000 ? 
              (avgSubs / 1000000).toFixed(1) + 'M' : 
              avgSubs > 1000 ? (avgSubs / 1000).toFixed(1) + 'K' : avgSubs;
      }

      function addDataRow(index, item) {
          const tbody = document.getElementById('dataTableBody');
          if (index === 0) {
              tbody.innerHTML = '';
          }
          
          const row = tbody.insertRow();
          const statusIcon = item.verified ? '✅ 已验证' : '⚪ 普通';
          const description = item.description ? 
              (item.description.length > 100 ? item.description.substring(0, 100) + '...' : item.description) : 
              '无简介';
          
          row.innerHTML = `
              <td>${index + 1}</td>
              <td><strong>${item.name || '未知'}</strong><br><small>${item.category || '未分类'}</small></td>
              <td><code>${item.username || '无用户名'}</code></td>
              <td><strong>${item.subscribersText || item.subscribers?.toLocaleString() || '0'}</strong></td>
              <td>${item.activity || '未知'}</td>
              <td class="description-cell">${description}</td>
              <td class="url-cell"><a href="${item.url}" target="_blank">访问</a></td>
              <td>${statusIcon}</td>
          `;
      }

      function saveCheckpoint() {
          checkpointData = {
              data: [...scrapingData],
              currentPage: currentPageNum,
              timestamp: Date.now(),
              config: {
                  url: document.getElementById('url').value,
                  maxPages: document.getElementById('maxPages').value,
                  scrapeType: document.getElementById('scrapeType').value
              }
          };
          
          localStorage.setItem('scraperCheckpoint', JSON.stringify(checkpointData));
          document.getElementById('checkpointStatus').textContent = `已保存 (${new Date().toLocaleString()})`;
          document.getElementById('loadCheckpointBtn').disabled = false;
          updateStatus('断点已保存', 'success');
          log('断点数据已保存到本地存储', 'success');
      }

      function loadCheckpoint() {
          const saved = localStorage.getItem('scraperCheckpoint');
          if (saved) {
              checkpointData = JSON.parse(saved);
              scrapingData = [...checkpointData.data];
              currentPageNum = checkpointData.currentPage;
              
              // 恢复配置
              document.getElementById('url').value = checkpointData.config.url;
              document.getElementById('maxPages').value = checkpointData.config.maxPages;
              document.getElementById('scrapeType').value = checkpointData.config.scrapeType;
              
              // 重新显示数据
              refreshDataTable();
              updateStats(scrapingData.length, currentPageNum, 95, 0, errorCount, calculateAvgSubscribers());
              
              updateStatus(`已加载断点数据 (${scrapingData.length}条记录)`, 'success');
              log(`从断点恢复 ${scrapingData.length} 条数据`, 'success');
              document.getElementById('downloadBtn').disabled = false;
          }
      }

      function clearCheckpoint() {
          localStorage.removeItem('scraperCheckpoint');
          checkpointData = null;
          document.getElementById('checkpointStatus').textContent = '无保存点';
          document.getElementById('loadCheckpointBtn').disabled = true;
          updateStatus('断点已清除', 'success');
          log('断点数据已清除', 'info');
      }

      function calculateAvgSubscribers() {
          if (scrapingData.length === 0) return 0;
          const total = scrapingData.reduce((sum, item) => sum + (item.subscribers || 0), 0);
          return Math.round(total / scrapingData.length);
      }

              function refreshDataTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            if (filteredData.length === 0 && scrapingData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #7f8c8d; padding: 40px;">
                            暂无数据，点击"开始爬取"开始工作
                        </td>
                    </tr>
                `;
                return;
            }
            
            const dataToShow = filteredData.length > 0 ? filteredData : scrapingData;
            dataToShow.forEach((item, index) => {
                addDataRow(index, item);
            });
        }

        function startScraping() {
            if (isScrapingActive) return;
            
            isScrapingActive = true;
            isPaused = false;
            errorCount = 0;
            
            // 如果不是从断点恢复，清空数据
            if (!checkpointData || currentPageNum === 0) {
                scrapingData = [];
                currentPageNum = 0;
            }
            
            startTime = Date.now();
            
            updateStatus('正在初始化爬虫...', 'loading');
            updateProgress(0, '准备开始爬取...');
            
            // 更新按钮状态
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('saveCheckpointBtn').disabled = false;
            
            // 开始计时器
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                updateStats(scrapingData.length, currentPageNum, 95, elapsed, errorCount, calculateAvgSubscribers());
            }, 1000);
            
            log('开始爬取任务', 'info');
            simulateScraping();
        }

        function simulateScraping() {
            const maxPages = parseInt(document.getElementById('maxPages').value);
            const delay = parseFloat(document.getElementById('delay').value) * 1000;
            const concurrency = parseInt(document.getElementById('concurrency').value);
            
            function scrapePage(pageNum) {
                if (!isScrapingActive || pageNum >= maxPages) {
                    completeScraping();
                    return;
                }
                
                if (isPaused) {
                    updateStatus('爬取已暂停，点击继续按钮恢复', 'paused');
                    return;
                }
                
                currentPageNum = pageNum + 1;
                const progressPercent = (currentPageNum / maxPages) * 100;
                updateStatus(`正在爬取第 ${currentPageNum} 页...`, 'loading');
                updateProgress(progressPercent, `处理第 ${currentPageNum}/${maxPages} 页`);
                
                log(`开始爬取第 ${currentPageNum} 页`, 'info');
                
                setTimeout(() => {
                    // 模拟可能的错误
                    if (Math.random() < 0.1) {
                        errorCount++;
                        log(`第 ${currentPageNum} 页爬取失败: 网络超时`, 'error');
                    }
                    
                    // 添加模拟数据
                    const pageData = enhancedSampleData.map((item, index) => ({
                        ...item,
                        name: item.name + ` (P${currentPageNum})`,
                        id: scrapingData.length + index,
                        subscribers: item.subscribers + Math.floor(Math.random() * 100000),
                        subscribersText: formatSubscribers(item.subscribers + Math.floor(Math.random() * 100000)),
                        activity: getRandomActivity(),
                        extractedAt: new Date().toISOString()
                    }));
                    
                    pageData.forEach((item, index) => {
                        scrapingData.push(item);
                        addDataRow(scrapingData.length - 1, item);
                        log(`提取数据: ${item.name} - ${item.subscribersText} 关注者`, 'success');
                    });
                    
                    // 自动保存断点
                    if (currentPageNum % 5 === 0) {
                        saveCheckpoint();
                    }
                    
                    scrapePage(pageNum + 1);
                }, delay);
            }
            
            scrapePage(currentPageNum);
        }

        function formatSubscribers(count) {
            if (count >= 1000000) {
                return (count / 1000000).toFixed(1) + 'M';
            } else if (count >= 1000) {
                return (count / 1000).toFixed(1) + 'K';
            }
            return count.toString();
        }

        function getRandomActivity() {
            const activities = ['刚刚', '5分钟前', '1小时前', '6小时前', '12小时前', '1天前', '2天前', '1周前'];
            return activities[Math.floor(Math.random() * activities.length)];
        }

        function pauseScraping() {
            if (isScrapingActive && !isPaused) {
                isPaused = true;
                updateStatus('爬取已暂停', 'paused');
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('resumeBtn').disabled = false;
                log('爬取任务已暂停', 'warning');
            }
        }

        function resumeScraping() {
            if (isScrapingActive && isPaused) {
                isPaused = false;
                document.getElementById('pauseBtn').disabled = false;
                document.getElementById('resumeBtn').disabled = true;
                log('爬取任务已恢复', 'info');
                simulateScraping();
            }
        }

        function stopScraping() {
            isScrapingActive = false;
            isPaused = false;
            clearInterval(timerInterval);
            
            updateStatus('爬取已停止', 'error');
            updateProgress(0, '已停止');
            
            // 重置按钮状态
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('resumeBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            
            log('爬取任务已停止', 'warning');
        }

        function completeScraping() {
            isScrapingActive = false;
            isPaused = false;
            clearInterval(timerInterval);
            
            updateStatus(`爬取完成！共获取 ${scrapingData.length} 条数据`, 'success');
            updateProgress(100, '爬取完成');
            
            // 重置按钮状态
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('resumeBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('downloadBtn').disabled = false;
            
            log(`爬取任务完成，共获取 ${scrapingData.length} 条数据`, 'success');
            
            // 清除断点
            clearCheckpoint();
        }

        function applyFilters() {
            const nameFilter = document.getElementById('filterName').value.toLowerCase();
            const minSubs = parseInt(document.getElementById('filterMinSubscribers').value) || 0;
            const maxSubs = parseInt(document.getElementById('filterMaxSubscribers').value) || Infinity;
            
            filteredData = scrapingData.filter(item => {
                const nameMatch = !nameFilter || item.name.toLowerCase().includes(nameFilter) || 
                                 item.username.toLowerCase().includes(nameFilter);
                const subsMatch = item.subscribers >= minSubs && item.subscribers <= maxSubs;
                return nameMatch && subsMatch;
            });
            
            refreshDataTable();
            log(`应用筛选条件，显示 ${filteredData.length}/${scrapingData.length} 条数据`, 'info');
        }

        function clearFilters() {
            document.getElementById('filterName').value = '';
            document.getElementById('filterMinSubscribers').value = '';
            document.getElementById('filterMaxSubscribers').value = '';
            filteredData = [];
            refreshDataTable();
            log('已清除所有筛选条件', 'info');
        }

        function downloadData() {
            const dataToDownload = filteredData.length > 0 ? filteredData : scrapingData;
            if (dataToDownload.length === 0) {
                alert('没有数据可下载');
                return;
            }
            
            const format = document.getElementById('outputFormat').value;
            let content, filename, mimeType;
            
            switch (format) {
                case 'json':
                    content = JSON.stringify(dataToDownload, null, 2);
                    filename = 'scraped_data.json';
                    mimeType = 'application/json';
                    break;
                case 'csv':
                    const headers = ['序号', '频道名称', '用户名', '关注数', '活跃度', '简介', '链接', '分类', '验证状态'].join(',');
                    const rows = dataToDownload.map((item, index) => [
                        index + 1,
                        `"${item.name || ''}"`,
                        `"${item.username || ''}"`,
                        item.subscribers || 0,
                        `"${item.activity || ''}"`,
                        `"${(item.description || '').replace(/"/g, '""')}"`,
                        `"${item.url || ''}"`,
                        `"${item.category || ''}"`,
                        item.verified ? '已验证' : '普通'
                    ].join(','));
                    content = headers + '\n' + rows.join('\n');
                    filename = 'scraped_data.csv';
                    mimeType = 'text/csv;charset=utf-8';
                    break;
                case 'xml':
                    content = '<?xml version="1.0" encoding="UTF-8"?>\n<channels>\n';
                    dataToDownload.forEach(item => {
                        content += '  <channel>\n';
                        content += `    <name><![CDATA[${item.name || ''}]]></name>\n`;
                        content += `    <username><![CDATA[${item.username || ''}]]></username>\n`;
                        content += `    <subscribers>${item.subscribers || 0}</subscribers>\n`;
                        content += `    <activity><![CDATA[${item.activity || ''}]]></activity>\n`;
                        content += `    <description><![CDATA[${item.description || ''}]]></description>\n`;
                        content += `    <url><![CDATA[${item.url || ''}]]></url>\n`;
                        content += `    <category><![CDATA[${item.category || ''}]]></category>\n`;
                        content += `    <verified>${item.verified || false}</verified>\n`;
                        content += '  </channel>\n';
                    });
                    content += '</channels>';
                    filename = 'scraped_data.xml';
                    mimeType = 'application/xml';
                    break;
                default:
                    content = JSON.stringify(dataToDownload, null, 2);
                    filename = 'scraped_data.json';
                    mimeType = 'application/json';
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log(`数据已下载: ${filename} (${dataToDownload.length} 条记录)`, 'success');
        }

        function exportFiltered() {
            if (filteredData.length === 0) {
                alert('没有筛选数据可导出，请先应用筛选条件');
                return;
            }
            downloadData();
        }

        function previewData() {
            const dataToPreview = filteredData.length > 0 ? filteredData : scrapingData;
            if (dataToPreview.length === 0) {
                alert('没有数据可预览');
                return;
            }
            
            const preview = JSON.stringify(dataToPreview.slice(0, 3), null, 2);
            alert(`数据预览（前3条）:\n\n${preview}`);
        }

        function clearData() {
            scrapingData = [];
            filteredData = [];
            currentPageNum = 0;
            errorCount = 0;
            
            refreshDataTable();
            updateStats(0, 0, 0, 0, 0, 0);
            updateProgress(0, '已清空');
            updateStatus('数据已清空', 'success');
            document.getElementById('downloadBtn').disabled = true;
            
            log('所有数据已清空', 'info');
        }

        function toggleLog() {
            const logSection = document.getElementById('logSection');
            const isVisible = logSection.style.display !== 'none';
            logSection.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                log('日志面板已打开', 'info');
            }
        }

        // 初始化检查断点
        document.addEventListener('DOMContentLoaded', function() {
            const saved = localStorage.getItem('scraperCheckpoint');
            if (saved) {
                const checkpoint = JSON.parse(saved);
                document.getElementById('checkpointStatus').textContent = 
                    `有保存点 (${new Date(checkpoint.timestamp).toLocaleString()})`;
                document.getElementById('loadCheckpointBtn').disabled = false;
            }
            
            log('爬虫工具已初始化', 'info');
        });

        // 根据爬取类型更新界面
        document.getElementById('scrapeType').addEventListener('change', function() {
            const type = this.value;
            const urlInput = document.getElementById('url');
            
            switch (type) {
                case 'tgstat':
                    urlInput.value = 'https://tgstat.com/tag/crypto';
                    break;
                case 'telegram':
                    urlInput.value = 'https://t.me/s/';
                    break;
                case 'general':
                    urlInput.value = 'https://example.com';
                    break;
                case 'social':
                    urlInput.value = 'https://twitter.com/search?q=crypto';
                    break;
                default:
                    urlInput.value = 'https://example.com';
            }
            
            log(`切换爬取类型: ${type}`, 'info');
        });

        // 实时筛选
        ['filterName', 'filterMinSubscribers', 'filterMaxSubscribers'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                if (scrapingData.length > 0) {
                    setTimeout(applyFilters, 300);
                }
            });
        });
    </script>
</body>
</html>
