<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TGStat 频道抓取器 · 单文件HTML</title>
  <style>
    /* 样式部分省略，保持和之前一致 */
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TGStat 频道抓取器 <span class="chip">单文件 HTML</span></h1>
    <input id="startUrl" value="https://en.tgstat.com/ratings/channels/crypto?sort=members" />
    <button id="btnStart">开始抓取</button>
    <div id="status"></div>
    <table id="tbl"><thead><tr>
      <th>#</th><th>title</th><th>handle</th><th>subscribers</th><th>url</th>
    </tr></thead><tbody id="tbody"></tbody></table>
  </div>

<script>
(() => {
  const $ = (sel, root=document) => root.querySelector(sel);
  const dom = { startUrl: $('#startUrl'), btnStart: $('#btnStart'), status: $('#status'), tbody: $('#tbody') };
  let resultsMap = new Map();

  function setStatus(text){ dom.status.textContent = text; }

  function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  function extractHandleFromHref(href){
    try{
      const u = decodeURIComponent(href);
      const m = u.match(/\/channel\/%40([^/?#]+)/);
      return m? '@'+m[1] : null;
    }catch{ return null; }
  }

  function parseIntLoose(s){
    if(!s) return null;
    const cleaned = (s+"").replace(/[\s,]/g, "");
    const num = parseInt(cleaned,10);
    return isNaN(num)? null : num;
  }

  function parseListPage(html, pageUrl){
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const items = [];
    doc.querySelectorAll('a[href^="/channel/%40"]').forEach(a => {
      const href = a.getAttribute('href');
      const title = a.textContent.trim();
      const handle = extractHandleFromHref(href);
      const url = new URL(href, pageUrl).toString();
      let subs = null;
      const txt = a.closest('article,div,tr,li')?.innerText || "";
      const m = txt.match(/([\d,.]+)\s+subscribers/i);
      if(m) subs = parseIntLoose(m[1]);
      items.push({title, handle, url, subscribers: subs});
    });
    const nextLink = doc.querySelector('a[rel="next"]');
    const nextUrl = nextLink? new URL(nextLink.getAttribute('href'), pageUrl).toString() : null;
    return {items, nextUrl};
  }

  async function fetchText(url){
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.text();
  }

  function render(){
    dom.tbody.innerHTML = [...resultsMap.values()].map(r=>`
      <tr>
        <td></td>
        <td>${escapeHtml(r.title||'')}</td>
        <td>${escapeHtml(r.handle||'')}</td>
        <td>${r.subscribers??''}</td>
        <td><a href="${r.url}" target="_blank">链接</a></td>
      </tr>
    `).join('');
  }

  async function start(){
    resultsMap.clear(); render();
    let url = dom.startUrl.value.trim();
    let page = 0;
    while(url && page < 5){
      setStatus(`抓取第 ${page+1} 页: ${url}`);
      const html = await fetchText(url);
      const {items, nextUrl} = parseListPage(html, url);
      items.forEach(it => { resultsMap.set(it.handle||it.url, it); });
      render();
      url = nextUrl; page++;
    }
    setStatus(`完成，共 ${resultsMap.size} 条`);
  }

  dom.btnStart.addEventListener('click', start);
})();
</script>
</body>
</html>
