<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>AI æ¢è£…ç”Ÿå›¾å°æ¸¸æˆ - ChatAnywhere API è½¬å‘</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 40px;
      max-width: 900px;
      margin: auto;
      background-color: #f4f4f4;
    }
    textarea, input, select, button {
      width: 100%;
      margin-bottom: 15px;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      font-weight: bold;
      transition: background-color 0.3s ease;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #output, #debug {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      min-height: 80px;
      white-space: pre-wrap;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
    }
    img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    #debug {
      background: #fef9e7;
      font-size: 13px;
      color: #333;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .option-group {
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
    }
    .option-title {
      font-size: 18px;
      margin-top: 0;
      margin-bottom: 15px;
      color: #007bff;
    }
    .avatar-preview {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      display: block;
      margin: 10px 0;
      border: 3px solid #007bff;
    }
    .history-item {
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
    }
    .history-item:hover {
      background-color: #f0f0f0;
    }
    .history-image {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 5px;
      margin-right: 10px;
    }
    .tab {
      overflow: hidden;
      border: 1px solid #ccc;
      background-color: #f1f1f1;
      border-radius: 5px 5px 0 0;
    }
    .tab button {
      background-color: inherit;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 16px;
      transition: 0.3s;
      width: auto;
      color: #333;
      font-weight: normal;
    }
    .tab button:hover {
      background-color: #ddd;
    }
    .tab button.active {
      background-color: #007bff;
      color: white;
    }
    .tabcontent {
      display: none;
      padding: 20px;
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 5px 5px;
      background-color: white;
    }
    #historyTab {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }
    .loading {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 3px solid rgba(0,123,255,.3);
      border-radius: 50%;
      border-top-color: #007bff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .loading-text {
      margin-top: 10px;
      color: #007bff;
    }
  </style>
</head>
<body>
  <h2>ğŸ® AI æ¢è£…ç”Ÿå›¾å°æ¸¸æˆï¼ˆChatAnywhere è½¬å‘ç‰ˆï¼‰</h2>
  
  <div class="tab">
    <button class="tablinks active" onclick="openTab(event, 'generatorTab')">ç”Ÿæˆå™¨</button>
    <button class="tablinks" onclick="openTab(event, 'historyTab')">å†å²è®°å½•</button>
  </div>

  <div id="generatorTab" class="tabcontent" style="display: block;">
    <label>ğŸ”‘ API Keyï¼ˆå¿…å¡«ï¼‰</label>
    <input type="password" id="apikey" placeholder="è¯·è¾“å…¥ä½ çš„ API Keyï¼Œä¾‹å¦‚ sk-xxxx..." />

    <div class="grid">
      <div class="option-group">
        <h3 class="option-title">ğŸ‘¤ å¤´åƒè®¾ç½®</h3>
        <label for="avatarUpload">ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒï¼ˆå¯é€‰ï¼‰</label>
        <input type="file" id="avatarUpload" accept="image/*" onchange="previewAvatar()" />
        <img id="avatarPreview" class="avatar-preview" src="https://via.placeholder.com/150?text=é¢„è§ˆ" alt="å¤´åƒé¢„è§ˆ" />
        <button onclick="clearAvatar()">æ¸…é™¤å¤´åƒ</button>
      </div>

      <div class="option-group">
        <h3 class="option-title">ğŸ‘« åŸºæœ¬å±æ€§</h3>
        <label for="gender">æ€§åˆ«</label>
        <select id="gender">
          <option value="ç”·æ€§">ç”·æ€§</option>
          <option value="å¥³æ€§">å¥³æ€§</option>
          <option value="ä¸­æ€§">ä¸­æ€§</option>
        </select>
        
        <label for="style">è‰ºæœ¯é£æ ¼</label>
        <select id="style">
          <option value="å†™å®é£æ ¼">å†™å®é£æ ¼</option>
          <option value="å¡é€šé£æ ¼">å¡é€šé£æ ¼</option>
          <option value="åŠ¨æ¼«é£æ ¼">åŠ¨æ¼«é£æ ¼</option>
          <option value="èµ›åšæœ‹å…‹">èµ›åšæœ‹å…‹</option>
          <option value="æ°´å½©ç”»é£">æ°´å½©ç”»é£</option>
          <option value="æ²¹ç”»é£æ ¼">æ²¹ç”»é£æ ¼</option>
        </select>
      </div>

      <div class="option-group">
        <h3 class="option-title">ğŸ‘” ç€è£…é€‰æ‹©</h3>
        <label for="clothing">æœè£…ç±»å‹</label>
        <select id="clothing">
          <option value="ä¼‘é—²è£…">ä¼‘é—²è£…</option>
          <option value="æ­£è£…è¥¿æœ">æ­£è£…è¥¿æœ</option>
          <option value="è¿åŠ¨è£…">è¿åŠ¨è£…</option>
          <option value="ä¼ ç»Ÿæœé¥°">ä¼ ç»Ÿæœé¥°</option>
          <option value="åˆ¶æœ">åˆ¶æœ</option>
          <option value="å¥‡å¹»æœè£…">å¥‡å¹»æœè£…</option>
          <option value="æœªæ¥ç§‘æŠ€è£…">æœªæ¥ç§‘æŠ€è£…</option>
        </select>
        
        <label for="clothingColor">æœè£…é¢œè‰²</label>
        <select id="clothingColor">
          <option value="çº¢è‰²">çº¢è‰²</option>
          <option value="è“è‰²">è“è‰²</option>
          <option value="ç»¿è‰²">ç»¿è‰²</option>
          <option value="é»‘è‰²">é»‘è‰²</option>
          <option value="ç™½è‰²">ç™½è‰²</option>
          <option value="ç´«è‰²">ç´«è‰²</option>
          <option value="é»„è‰²">é»„è‰²</option>
        </select>
        
        <label for="clothingDetail">æœè£…ç»†èŠ‚ï¼ˆå¯é€‰ï¼‰</label>
        <input type="text" id="clothingDetail" placeholder="ä¾‹å¦‚ï¼šå¸¦èŠ±çº¹ã€æœ‰å¾½ç« ã€ç ´æ´ç‰›ä»”ç­‰" />
      </div>

      <div class="option-group">
        <h3 class="option-title">ğŸŒ ç¯å¢ƒè®¾ç½®</h3>
        <label for="environment">åœºæ™¯ç¯å¢ƒ</label>
        <select id="environment">
          <option value="åŸå¸‚è¡—é“">åŸå¸‚è¡—é“</option>
          <option value="è‡ªç„¶é£æ™¯">è‡ªç„¶é£æ™¯</option>
          <option value="æµ·æ»©">æµ·æ»©</option>
          <option value="åŠå…¬å®¤">åŠå…¬å®¤</option>
          <option value="å’–å•¡å…">å’–å•¡å…</option>
          <option value="ç§‘å¹»åœºæ™¯">ç§‘å¹»åœºæ™¯</option>
          <option value="å¥‡å¹»ä¸–ç•Œ">å¥‡å¹»ä¸–ç•Œ</option>
          <option value="å¤ªç©º">å¤ªç©º</option>
        </select>
        
        <label for="timeOfDay">æ—¶é—´</label>
        <select id="timeOfDay">
          <option value="ç™½å¤©">ç™½å¤©</option>
          <option value="é»„æ˜">é»„æ˜</option>
          <option value="å¤œæ™š">å¤œæ™š</option>
          <option value="é»æ˜">é»æ˜</option>
        </select>
        
        <label for="weather">å¤©æ°”</label>
        <select id="weather">
          <option value="æ™´æœ—">æ™´æœ—</option>
          <option value="é›¨å¤©">é›¨å¤©</option>
          <option value="é›ªå¤©">é›ªå¤©</option>
          <option value="å¤šäº‘">å¤šäº‘</option>
          <option value="é›¾å¤©">é›¾å¤©</option>
        </select>
      </div>
      
      <div class="option-group">
        <h3 class="option-title">ğŸ­ åŠ¨ä½œå§¿åŠ¿</h3>
        <label for="pose">åŠ¨ä½œ</label>
        <select id="pose">
          <option value="ç«™ç«‹">ç«™ç«‹</option>
          <option value="è¡Œèµ°">è¡Œèµ°</option>
          <option value="è·‘æ­¥">è·‘æ­¥</option>
          <option value="è·³è·ƒ">è·³è·ƒ</option>
          <option value="èˆè¹ˆ">èˆè¹ˆ</option>
          <option value="åç€">åç€</option>
          <option value="èººç€">èººç€</option>
          <option value="æˆ˜æ–—å§¿åŠ¿">æˆ˜æ–—å§¿åŠ¿</option>
        </select>
        
        <label for="expression">è¡¨æƒ…</label>
        <select id="expression">
          <option value="å¾®ç¬‘">å¾®ç¬‘</option>
          <option value="å¤§ç¬‘">å¤§ç¬‘</option>
          <option value="ä¸¥è‚ƒ">ä¸¥è‚ƒ</option>
          <option value="æƒŠè®¶">æƒŠè®¶</option>
          <option value="æ²‰æ€">æ²‰æ€</option>
          <option value="æ‚²ä¼¤">æ‚²ä¼¤</option>
          <option value="æ„¤æ€’">æ„¤æ€’</option>
        </select>
      </div>
      
      <div class="option-group">
        <h3 class="option-title">ğŸ é“å…·é€‰æ‹©</h3>
        <label for="prop1">ä¸»è¦é“å…·</label>
        <select id="prop1">
          <option value="æ— ">æ— </option>
          <option value="æ‰‹æœº">æ‰‹æœº</option>
          <option value="ä¹¦æœ¬">ä¹¦æœ¬</option>
          <option value="èƒŒåŒ…">èƒŒåŒ…</option>
          <option value="ç›¸æœº">ç›¸æœº</option>
          <option value="æ­¦å™¨">æ­¦å™¨</option>
          <option value="é­”æ³•æ£’">é­”æ³•æ£’</option>
          <option value="ä¹å™¨">ä¹å™¨</option>
          <option value="å® ç‰©">å® ç‰©</option>
        </select>
        
        <label for="prop2">æ¬¡è¦é“å…·ï¼ˆå¯é€‰ï¼‰</label>
        <select id="prop2">
          <option value="æ— ">æ— </option>
          <option value="çœ¼é•œ">çœ¼é•œ</option>
          <option value="å¸½å­">å¸½å­</option>
          <option value="å›´å·¾">å›´å·¾</option>
          <option value="æ‰‹è¡¨">æ‰‹è¡¨</option>
          <option value="è€³æœº">è€³æœº</option>
          <option value="é¡¹é“¾">é¡¹é“¾</option>
          <option value="æ‰‹å¥—">æ‰‹å¥—</option>
        </select>
      </div>
    </div>

    <label for="additionalDetails">é¢å¤–ç»†èŠ‚æè¿°ï¼ˆå¯é€‰ï¼‰</label>
    <textarea id="additionalDetails" placeholder="æ·»åŠ ä»»ä½•å…¶ä»–ä½ æƒ³è¦çš„ç»†èŠ‚æè¿°..."></textarea>

    <button onclick="generateImage()">ğŸš€ ç”Ÿæˆæˆ‘çš„å½¢è±¡</button>

    <div id="output">ğŸ” ç”Ÿæˆçš„å›¾åƒå°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>

    <h3>ğŸ è°ƒè¯•ä¿¡æ¯</h3>
    <div id="debug">è¿™é‡Œä¼šæ˜¾ç¤ºè¯·æ±‚ä½“ã€è¿”å›å†…å®¹ã€é”™è¯¯ä¿¡æ¯ç­‰</div>
  </div>

  <div id="historyTab" class="tabcontent">
    <h3>å†å²ç”Ÿæˆè®°å½•</h3>
    <div id="historyContainer">
      <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      <p>æš‚æ— å†å²è®°å½•</p>
    </div>
  </div>

  <script>
    // ä½¿ç”¨ ChatAnywhere çš„å›½å†…è½¬å‘åœ°å€
    const API_URL_TEXT = "https://api.chatanywhere.tech/v1/chat/completions";
    const API_URL_IMAGE = "https://api.chatanywhere.tech/v1/images/generations";
    const API_URL_IMAGE_EDIT = "https://api.chatanywhere.tech/v1/images/edits";

    // å­˜å‚¨å†å²è®°å½•
    let generationHistory = JSON.parse(localStorage.getItem('imageHistory')) || [];
    
    // å¤´åƒç›¸å…³å˜é‡
    let avatarFile = null;
    let avatarBase64 = null;

    // é¢„è§ˆä¸Šä¼ çš„å¤´åƒ
    function previewAvatar() {
      const fileInput = document.getElementById('avatarUpload');
      const preview = document.getElementById('avatarPreview');
      
      if (fileInput.files && fileInput.files[0]) {
        avatarFile = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
          preview.src = e.target.result;
          avatarBase64 = e.target.result;
        }
        
        reader.readAsDataURL(avatarFile);
      }
    }
    
    // æ¸…é™¤å¤´åƒ
    function clearAvatar() {
      document.getElementById('avatarUpload').value = '';
      document.getElementById('avatarPreview').src = 'https://via.placeholder.com/150?text=é¢„è§ˆ';
      avatarFile = null;
      avatarBase64 = null;
    }

    // ç”Ÿæˆæç¤ºè¯
    function generatePrompt() {
      const gender = document.getElementById('gender').value;
      const clothing = document.getElementById('clothing').value;
      const clothingColor = document.getElementById('clothingColor').value;
      const clothingDetail = document.getElementById('clothingDetail').value;
      const environment = document.getElementById('environment').value;
      const timeOfDay = document.getElementById('timeOfDay').value;
      const weather = document.getElementById('weather').value;
      const pose = document.getElementById('pose').value;
      const expression = document.getElementById('expression').value;
      const prop1 = document.getElementById('prop1').value;
      const prop2 = document.getElementById('prop2').value;
      const style = document.getElementById('style').value;
      const additionalDetails = document.getElementById('additionalDetails').value;

      let prompt = `ä¸€ä¸ª${gender}è§’è‰²ï¼Œç©¿ç€${clothingColor}${clothing}`;
      
      if (clothingDetail) {
        prompt += `ï¼Œ${clothingDetail}`;
      }
      
      prompt += `ï¼Œåœ¨${timeOfDay}${weather}çš„${environment}ä¸­${pose}`;
      
      if (expression) {
        prompt += `ï¼Œè¡¨æƒ…${expression}`;
      }
      
      if (prop1 !== 'æ— ') {
        prompt += `ï¼Œæ‰‹æŒ${prop1}`;
      }
      
      if (prop2 !== 'æ— ') {
        prompt += `ï¼Œä½©æˆ´ç€${prop2}`;
      }
      
      prompt += `ï¼Œ${style}`;
      
      if (additionalDetails) {
        prompt += `ï¼Œ${additionalDetails}`;
      }
      
      prompt += 'ï¼Œé«˜è´¨é‡ï¼Œç»†èŠ‚ä¸°å¯Œï¼Œ4K';
      
      return prompt;
    }

    // ç”Ÿæˆå›¾åƒ
    async function generateImage() {
      const apiKey = document.getElementById('apikey').value.trim();
      const output = document.getElementById('output');
      const debug = document.getElementById('debug');
      
      if (!apiKey) {
        alert('âš ï¸ è¯·å¡«å†™ API Keyï¼');
        return;
      }
      
      const prompt = generatePrompt();
      
      // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
      output.innerHTML = `
        <div class="loading-container">
          <div class="loading"></div>
          <div class="loading-text">â³ æ­£åœ¨ç”Ÿæˆï¼Œè¯·ç¨å€™...</div>
        </div>
      `;
      
      debug.innerText = 'ğŸ” æ­£åœ¨å‡†å¤‡è¯·æ±‚...';
      
      try {
        let url = '';
        let body = {};
        let formData = null;
        let headers = {
          'Authorization': `Bearer ${apiKey}`
        };
        
        // åˆ¤æ–­æ˜¯å¦ä½¿ç”¨å›¾ç”Ÿå›¾æ¨¡å¼
        if (avatarFile) {
          url = API_URL_IMAGE_EDIT;
          formData = new FormData();
          formData.append('image', avatarFile);
          formData.append('prompt', prompt);
          formData.append('n', 1);
          formData.append('size', '1024x1024');
          formData.append('response_format', 'b64_json'); // ç¡®ä¿è¿”å›base64æ ¼å¼
          
          debug.innerText = `ğŸ”— è¯·æ±‚åœ°å€ï¼š${url}\n\nğŸ“¤ è¯·æ±‚ä½“ï¼šå›¾ç”Ÿå›¾æ¨¡å¼ï¼Œä¸Šä¼ å¤´åƒ + "${prompt}"`;
        } else {
          url = API_URL_IMAGE;
          body = {
            prompt: prompt,
            n: 1,
            size: "1024x1024",
            response_format: "b64_json" // ç¡®ä¿è¿”å›base64æ ¼å¼
          };
          
          headers['Content-Type'] = 'application/json';
          debug.innerText = `ğŸ”— è¯·æ±‚åœ°å€ï¼š${url}\n\nğŸ“¤ è¯·æ±‚ä½“ï¼š\n${JSON.stringify(body, null, 2)}`;
        }
        
        let response;
        
        if (formData) {
          response = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: formData
          });
        } else {
          response = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body)
          });
        }
        
        const data = await response.json();
        
        if (data.error) {
          output.innerText = `âŒ å‡ºé”™ï¼š${data.error.message || 'æœªçŸ¥é”™è¯¯'}`;
          debug.innerText += `\n\nğŸ“¥ è¿”å›é”™è¯¯ï¼š\n${JSON.stringify(data, null, 2)}`;
        } else {
          // å¤„ç†è¿”å›çš„base64å›¾åƒæ•°æ®
          const b64Image = data.data?.[0]?.b64_json;
          
          if (b64Image) {
            // åˆ›å»ºå›¾åƒURL
            const imageUrl = `data:image/png;base64,${b64Image}`;
            output.innerHTML = `<img src="${imageUrl}" alt="ç”Ÿæˆå›¾åƒ" />`;
            
            // ä¿å­˜åˆ°å†å²è®°å½•
            const timestamp = new Date().toLocaleString();
            const historyItem = {
              id: Date.now(),
              imageUrl: imageUrl, // ä¿å­˜base64å›¾åƒ
              prompt: prompt,
              timestamp: timestamp,
              settings: {
                gender: document.getElementById('gender').value,
                clothing: document.getElementById('clothing').value,
                environment: document.getElementById('environment').value,
                pose: document.getElementById('pose').value,
                style: document.getElementById('style').value
              }
            };
            
            generationHistory.unshift(historyItem);
            if (generationHistory.length > 50) generationHistory.pop(); // é™åˆ¶å†å²è®°å½•æ•°é‡
            localStorage.setItem('imageHistory', JSON.stringify(generationHistory));
            updateHistoryDisplay();
          } else {
            output.innerText = 'âŒ å›¾åƒç”Ÿæˆå¤±è´¥ - æœªæ”¶åˆ°æœ‰æ•ˆçš„å›¾åƒæ•°æ®';
          }
          
          // é™åˆ¶è°ƒè¯•ä¿¡æ¯é•¿åº¦ï¼Œé¿å…æ˜¾ç¤ºå¤ªé•¿çš„base64å­—ç¬¦ä¸²
          let debugData = JSON.parse(JSON.stringify(data));
          if (debugData.data && debugData.data[0] && debugData.data[0].b64_json) {
            debugData.data[0].b64_json = debugData.data[0].b64_json.substring(0, 100) + '... [æˆªæ–­]';
          }
          debug.innerText += `\n\nğŸ“¥ è¿”å›å†…å®¹ï¼š\n${JSON.stringify(debugData, null, 2)}`;
        }
      } catch (err) {
        output.innerText = 'âŒ è¯·æ±‚å¤±è´¥ï¼š' + err.message;
        debug.innerText += `\n\nâ— é”™è¯¯ä¿¡æ¯ï¼š${err.message}`;
      }
    }
    
    // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
    function updateHistoryDisplay() {
      const container = document.getElementById('historyContainer');
      
      if (generationHistory.length === 0) {
        container.innerHTML = '<p>æš‚æ— å†å²è®°å½•</p>';
        return;
      }
      
      container.innerHTML = '';
      
      generationHistory.forEach(item => {
        const historyCard = document.createElement('div');
        historyCard.className = 'history-item';
        historyCard.innerHTML = `
          <img src="${item.imageUrl}" class="history-image" alt="å†å²å›¾åƒ" />
          <div>
            <small>${item.timestamp}</small>
            <p>${item.settings.gender} | ${item.settings.clothing} | ${item.settings.environment}</p>
          </div>
        `;
        
        historyCard.addEventListener('click', () => {
          document.getElementById('output').innerHTML = `<img src="${item.imageUrl}" alt="å†å²å›¾åƒ" />`;
          document.getElementById('debug').innerText = `ä»å†å²è®°å½•åŠ è½½ï¼š\n${item.prompt}`;
          
          // åˆ‡æ¢åˆ°ç”Ÿæˆå™¨æ ‡ç­¾
          document.querySelectorAll('.tablinks')[0].click();
        });
        
        container.appendChild(historyCard);
      });
    }
    
    // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
    function openTab(evt, tabName) {
      const tabcontent = document.getElementsByClassName('tabcontent');
      for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = 'none';
      }
      
      const tablinks = document.getElementsByClassName('tablinks');
      for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(' active', '');
      }
      
      document.getElementById(tabName).style.display = 'block';
      evt.currentTarget.className += ' active';
      
      if (tabName === 'historyTab') {
        updateHistoryDisplay();
      }
    }
    
    // åˆå§‹åŒ–
    updateHistoryDisplay();
  </script>
</body>
</html>
